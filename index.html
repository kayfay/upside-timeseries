<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upside Time Series Analysis - Business Intelligence Dashboard</title>

    <!-- Modern CSS Framework -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap"
        rel="stylesheet">


    <style>
        :root {
            /* Editorial color palette - earth tones, warm, sophisticated */
            --primary-color: #8B4513;
            --primary-dark: #654321;
            --secondary-color: #6B8E6B;
            --accent-color: #C97D60;
            --accent-cool: #7A9CC6;
            --success-color: #6B8E6B;
            --warning-color: #C97D60;
            --error-color: #8B4513;
            --text-primary: #2C2416;
            --text-secondary: #5C4E37;
            --text-light: #9CA3AF;
            --bg-primary: #FDFBF7;
            --bg-secondary: #FAF8F3;
            --bg-tertiary: #F5F3ED;
            --border-color: #E8E4DC;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
        }

        body {
            font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.7;
            color: var(--text-primary);
            background: var(--bg-primary);
            min-height: 100vh;
            font-weight: 400;
            overflow-x: hidden;
            width: 100%;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 60px;
            width: 100%;
            box-sizing: border-box;
        }

        /* Header Styles */
        .header {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .header-main {
            flex: 1;
            text-align: left;
        }

        .language-toggle {
            flex-shrink: 0;
            margin-left: 2rem;
        }

        .toggle-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.02em;
        }

        .toggle-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .toggle-btn:hover::before {
            left: 100%;
        }

        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .toggle-btn:active {
            transform: translateY(0);
        }

        .toggle-btn.business-mode {
            background: var(--secondary-color);
        }

        .toggle-btn.business-mode .toggle-text {
            content: "Scientific View";
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--primary-color);
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: white;
            padding: 1.75rem;
            border-radius: var(--radius-md);
            border: 1.5px solid var(--border-color);
            border-left: 4px solid var(--primary-color);
            text-align: left;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            display: none;
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Navigation - Editorial Style */
        .nav-tabs {
            display: flex;
            background: transparent;
            padding: 0;
            margin-bottom: 3rem;
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            gap: 0;
            justify-content: space-between;
            align-items: flex-end;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-family: 'Source Sans Pro', sans-serif;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            position: relative;
            margin-bottom: -2px;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .nav-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--primary-color);
        }

        .nav-tab.active::after {
            transform: scaleX(1);
        }

        .nav-tab:hover:not(.active) {
            color: var(--text-primary);
        }

        .nav-tab:hover:not(.active)::after {
            transform: scaleX(1);
            background: var(--accent-color);
        }

        .nav-tab i {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section {
            background: transparent;
            padding: 0;
            margin-bottom: 4rem;
            border: none;
            box-shadow: none;
        }

        .section>h2 {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            margin-top: 0;
            line-height: 1.1;
            letter-spacing: -0.03em;
            max-width: 60%;
            transform: rotate(-0.5deg);
        }

        .section>p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-bottom: 3rem;
            line-height: 1.8;
            max-width: 45%;
            margin-left: 55%;
            font-style: italic;
        }

        /* Editorial Asymmetric Layout */
        .gallery {
            display: block;
            margin-top: 3rem;
            position: relative;
        }

        .section {
            position: relative;
            overflow: visible;
        }

        /* Dynamic Dashboard Styles */
        .dynamic-dashboard {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            border: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            padding-bottom: 1.25rem;
            border-bottom: 2px solid var(--border-color);
        }

        .dashboard-header h3 {
            font-family: 'Playfair Display', serif;
            margin: 0;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        .dashboard-controls {
            display: flex;
            gap: 0.75rem;
        }

        .dashboard-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.01em;
        }

        .dashboard-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .metrics-grid {
            display: block;
            margin-bottom: 4rem;
            position: relative;
        }

        .metric-card {
            background: white;
            padding: 2rem;
            border-radius: 0;
            border: 2px solid var(--border-color);
            border-left: 8px solid var(--primary-color);
            text-align: left;
            transition: all 0.3s ease;
            position: relative;
            overflow: visible;
            margin-bottom: 1.5rem;
            width: 32%;
            display: inline-block;
            vertical-align: top;
            margin-right: 1.5%;
            box-shadow: 4px -4px 0 rgba(139, 69, 19, 0.1);
            transform: rotate(0.2deg);
        }

        .metric-card:nth-child(3n+2) {
            transform: rotate(-0.3deg);
            margin-left: 1.5%;
            margin-right: 1.5%;
        }

        .metric-card:nth-child(3n) {
            transform: rotate(0.4deg);
            margin-right: 0;
        }

        .metric-card::before {
            display: none;
        }

        .metric-card:hover::before {
            transform: scaleX(1);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .metric-icon {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--primary-color);
            opacity: 0.7;
        }

        .metric-value {
            font-family: 'IBM Plex Mono', 'SF Mono', Monaco, monospace;
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .metric-label {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0.75rem;
        }

        .metric-description {
            font-size: 0.875rem;
            color: var(--text-light);
            line-height: 1.4;
        }

        .metric-trend {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .metric-trend.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .metric-trend.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }

        .metric-trend.neutral {
            background: rgba(156, 163, 175, 0.1);
            color: var(--text-secondary);
        }

        .image-card {
            background: transparent;
            border-radius: 0;
            overflow: visible;
            box-shadow: none;
            border: none;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            text-decoration: none;
            color: inherit;
            margin-bottom: 5rem;
            padding: 2rem 0;
        }

        .image-card a {
            text-decoration: none;
            color: inherit;
            pointer-events: none;
        }

        .image-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .image-card.featured {
            border: none;
        }

        .image-card.featured::before {
            display: none;
        }

        .image-card img {
            width: 70%;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
            margin-left: 10%;
            margin-right: 10%;
            margin-bottom: 4rem;
            margin-top: 2rem;
            box-shadow: 8px 8px 0 rgba(139, 69, 19, 0.15);
            transform: rotate(1deg);
            position: relative;
            max-width: calc(100% - 20%);
        }

        .image-card:hover img {
            transform: rotate(0.5deg) scale(1.01);
        }

        .image-info {
            padding: 0;
            margin-top: 0;
            margin-bottom: 3rem;
            position: relative;
            clear: both;
        }

        .image-info h3 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            margin-top: 2rem;
            max-width: 50%;
            line-height: 1.2;
            letter-spacing: -0.02em;
            margin-left: 5%;
            transform: rotate(-0.3deg);
            clear: both;
        }

        .filename {
            font-size: 0.75rem;
            color: var(--text-light);
            font-family: 'IBM Plex Mono', 'SF Mono', Monaco, monospace;
            margin-bottom: 2rem;
            margin-left: 15%;
            margin-top: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.6;
        }

        .image-info p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            line-height: 1.9;
            margin-top: 2rem;
            margin-bottom: 2rem;
            max-width: 85%;
            margin-left: 5%;
            clear: both;
        }

        /* Summary Cards */
        .summary-card {
            background: var(--primary-color);
            color: white;
            padding: 2.5rem 3rem;
            border-radius: 0;
            margin: 4rem 0;
            margin-left: 8%;
            margin-right: 20%;
            box-shadow: -12px 12px 0 rgba(139, 69, 19, 0.2);
            border-left: 8px solid var(--accent-color);
            transform: rotate(-0.8deg);
            position: relative;
            z-index: 1;
            clear: both;
        }

        .summary-card h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
        }

        .summary-card p {
            margin: 0;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.95);
            line-height: 1.6;
        }

        /* Insights Cards */
        .insights-grid {
            display: block;
            gap: 0;
            margin-top: 3rem;
            position: relative;
        }

        .insight-card {
            background: white;
            padding: 2.5rem;
            border-radius: 0;
            border: 2px solid var(--border-color);
            border-left: 8px solid var(--accent-color);
            margin-bottom: 2rem;
            width: 55%;
            margin-left: auto;
            margin-right: 0;
            box-shadow: 6px -6px 0 rgba(201, 125, 96, 0.15);
            transform: rotate(0.5deg);
        }

        .insight-card:nth-child(even) {
            margin-left: 0;
            margin-right: auto;
            transform: rotate(-0.5deg);
            border-left: none;
            border-right: 8px solid var(--secondary-color);
        }

        .insight-card h4 {
            font-family: 'Playfair Display', serif;
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1.125rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .insight-card ul {
            margin: 0;
            padding-left: 1.25rem;
        }

        .insight-card li {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .insight-card li strong {
            color: var(--text-primary);
        }

        /* Download Section */
        .download-section {
            background: transparent;
            padding: 0;
            margin-bottom: 2rem;
        }

        .download-grid {
            display: block;
            margin-top: 3rem;
        }

        .download-card {
            background: white;
            padding: 2rem;
            border-radius: 0;
            border: 2px solid var(--border-color);
            border-left: 8px solid var(--secondary-color);
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            width: 48%;
            display: inline-block;
            vertical-align: top;
            margin-right: 2%;
            box-shadow: 6px 6px 0 rgba(139, 69, 19, 0.1);
            transform: rotate(0.2deg);
            position: relative;
        }

        .download-card:nth-child(even) {
            margin-left: 2%;
            margin-right: 0;
            transform: rotate(-0.2deg);
            border-left: none;
            border-right: 8px solid var(--accent-color);
        }

        .download-card:hover {
            transform: rotate(0deg) translateY(-3px);
            box-shadow: 8px 8px 0 rgba(139, 69, 19, 0.15);
        }

        .download-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .download-card h4 {
            font-family: 'Playfair Display', serif;
            color: var(--text-primary);
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
            line-height: 1.3;
            flex: 1;
        }

        .download-meta {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        .download-card p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            line-height: 1.6;
            font-style: italic;
        }

        .download-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            border-radius: 0;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 3px 3px 0 rgba(139, 69, 19, 0.2);
        }

        .download-btn:hover {
            background: var(--primary-dark);
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0 rgba(139, 69, 19, 0.2);
        }

        .download-btn:active {
            transform: translate(0, 0);
            box-shadow: 2px 2px 0 rgba(139, 69, 19, 0.2);
        }

        .preview-btn {
            background: var(--secondary-color);
            box-shadow: 3px 3px 0 rgba(107, 142, 107, 0.2);
        }

        .preview-btn:hover {
            background: #5a7a5a;
            box-shadow: 5px 5px 0 rgba(107, 142, 107, 0.2);
        }

        /* Week Analyzer Styles */
        .week-analyzer-container {
            margin-top: 3rem;
            padding: 2rem 0;
        }

        .analyzer-controls {
            margin-bottom: 3rem;
        }

        .date-range-selector {
            display: flex;
            gap: 1.5rem;
            align-items: flex-end;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .date-input-group label {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .date-input {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 0;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 1rem;
            color: var(--text-primary);
            background: white;
            transition: all 0.3s ease;
            min-width: 180px;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 4px 4px 0 rgba(139, 69, 19, 0.15);
        }

        .analyze-btn {
            padding: 0.75rem 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 4px 4px 0 rgba(139, 69, 19, 0.2);
        }

        .analyze-btn:hover {
            background: var(--primary-dark);
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(139, 69, 19, 0.2);
        }

        .analyze-btn:active {
            transform: translate(0, 0);
            box-shadow: 2px 2px 0 rgba(139, 69, 19, 0.2);
        }

        .quick-select-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .quick-select-btn {
            padding: 0.5rem 1.25rem;
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            border-radius: 0;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .quick-select-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .analyzer-results {
            margin-top: 3rem;
        }

        .results-header {
            margin-bottom: 2.5rem;
        }

        .results-header h3 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .results-period {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 1rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .summary-stat-card {
            background: white;
            padding: 2rem;
            border: 2px solid var(--border-color);
            border-left: 8px solid var(--primary-color);
            box-shadow: 6px 6px 0 rgba(139, 69, 19, 0.1);
            transform: rotate(0.3deg);
            transition: all 0.3s ease;
        }

        .summary-stat-card:nth-child(even) {
            transform: rotate(-0.3deg);
            border-left: none;
            border-right: 8px solid var(--secondary-color);
        }

        .summary-stat-card:hover {
            transform: rotate(0deg) translateY(-3px);
            box-shadow: 8px 8px 0 rgba(139, 69, 19, 0.15);
        }

        .stat-label {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.75rem;
        }

        .stat-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-comparison {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .stat-comparison.positive {
            color: var(--success-color);
        }

        .stat-comparison.negative {
            color: var(--warning-color);
        }

        .results-details {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .detail-card {
            background: white;
            padding: 2.5rem;
            border: 2px solid var(--border-color);
            border-left: 8px solid var(--accent-color);
            box-shadow: 6px 6px 0 rgba(139, 69, 19, 0.1);
            transform: rotate(-0.5deg);
        }

        .detail-card:nth-child(even) {
            transform: rotate(0.5deg);
            border-left: none;
            border-right: 8px solid var(--secondary-color);
        }

        .detail-card h4 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }

        .detail-card p {
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 1rem;
        }

        .week-breakdown {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .week-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-left: 4px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .week-item:hover {
            background: var(--bg-tertiary);
            border-left-color: var(--primary-color);
        }

        .week-item.busy {
            border-left-color: var(--success-color);
        }

        .week-item.slow {
            border-left-color: var(--warning-color);
        }

        .week-item-date {
            font-family: 'Source Sans Pro', sans-serif;
            font-weight: 600;
            color: var(--text-primary);
        }

        .week-item-value {
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
            color: var(--text-primary);
        }

        .week-item-zscore {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .percentile-info {
            font-family: 'Source Sans Pro', sans-serif;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .percentile-bar {
            width: 100%;
            height: 30px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            margin: 1rem 0;
            position: relative;
            overflow: hidden;
        }

        .percentile-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
            transition: width 0.5s ease;
        }

        .analyzer-loading {
            text-align: center;
            padding: 3rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .analyzer-error {
            padding: 2rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--warning-color);
            border-left: 8px solid var(--warning-color);
            color: var(--text-primary);
            text-align: center;
        }

        /* Report Modal Styles */
        .report-modal {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            max-width: 90%;
            max-height: 90%;
            width: 800px;
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
            margin: auto;
            top: 50%;
            transform: translateY(-50%) scale(0.9);
        }

        .modal.show .report-modal {
            transform: translateY(-50%) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1.5rem;
            max-height: 60vh;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .report-content {
            color: var(--text-primary);
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .report-content h1,
        .report-content h2,
        .report-content h3,
        .report-content h4 {
            color: var(--text-primary);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .report-content h1 {
            font-size: 1.75rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .report-content h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .report-content h3 {
            font-size: 1.25rem;
        }

        .report-content p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .report-content ul,
        .report-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .report-content li {
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .report-content code {
            background: var(--bg-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.875rem;
        }

        .report-content pre {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: var(--radius-md);
            overflow-x: auto;
            margin: 1rem 0;
        }

        .report-content blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        /* Image Modal Specific Styles */
        .image-modal-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1002;
        }

        .image-modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
        }

        .image-modal-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .image-modal-controls .download-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .image-modal-controls .download-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .image-modal-body {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 5rem 2rem 2rem 2rem;
            box-sizing: border-box;
        }

        .modal-content {
            max-width: 90vw;
            max-height: 80vh;
            object-fit: contain;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            display: block;
        }

        .close {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.5);
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: none;
            padding: 0;
            margin: 0;
        }

        .close:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }


        .header {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .header h1 {
            font-size: 2rem;
            line-height: 1.2;
        }

        .header-content {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }

        .language-toggle {
            margin-left: 0;
            align-self: flex-end;
        }

        .toggle-btn {
            padding: 0.625rem 1rem;
            font-size: 0.85rem;
        }

        .section {
            padding: 1.5rem 1rem;
        }

        .section h2 {
            font-size: 2.5rem;
            line-height: 1.1;
            margin-bottom: 1rem;
        }

        .section p {
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .gallery {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .nav-tabs {
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 0;
            padding: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1.5rem;
        }

        .nav-tab {
            min-width: auto;
            max-width: none;
            padding: 0.875rem 1.25rem;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .insights-grid {
            grid-template-columns: 1fr;
            margin-top: 2rem;
        }

        /* Patterns Section - Image Cards Mobile */
        .image-card {
            margin-bottom: 3rem;
            padding: 1rem 0;
        }

        .image-card img {
            width: 100% !important;
            max-width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            margin-bottom: 2rem;
            margin-top: 1rem;
            transform: none !important;
        }

        .image-info {
            margin-bottom: 2rem;
        }

        .image-info h3 {
            font-size: 1.75rem;
            max-width: 100%;
            margin-left: 0;
            margin-top: 1rem;
            transform: none;
        }

        .filename {
            margin-left: 0;
            margin-top: 0.5rem;
        }

        .image-info p {
            max-width: 100%;
            margin-left: 0;
            font-size: 1rem;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Summary Cards Mobile */
        .summary-card {
            width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            margin-top: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            transform: none !important;
        }

        .summary-card h4 {
            font-size: 0.95rem;
        }

        .summary-card p {
            font-size: 0.85rem;
        }

        /* Insight Cards Mobile */
        .insight-card {
            width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transform: none !important;
        }

        .insight-card:nth-child(even) {
            margin-left: 0 !important;
            margin-right: 0 !important;
            transform: none !important;
        }

        .insight-card h4 {
            font-size: 1rem;
        }

        .insight-card li {
            font-size: 0.85rem;
        }

        .download-grid {
            display: block;
        }

        .download-card {
            width: 100% !important;
            display: block !important;
            margin-right: 0 !important;
            margin-left: 0 !important;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            transform: none !important;
        }

        .download-card:nth-child(even) {
            transform: none !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        .download-card-header {
            flex-direction: column;
            gap: 0.5rem;
        }

        .download-actions {
            flex-direction: column;
        }

        .download-btn {
            width: 100%;
            justify-content: center;
        }

        /* Dynamic Dashboard Responsive */
        .dynamic-dashboard {
            padding: 1rem 0;
        }

        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .dashboard-header h3 {
            font-size: 1.5rem;
            line-height: 1.2;
        }

        .dashboard-controls {
            width: 100%;
            display: flex;
            gap: 0.75rem;
        }

        .dashboard-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }

        .metrics-grid {
            margin-bottom: 2rem;
        }

        .metric-card {
            width: 100% !important;
            display: block !important;
            margin-right: 0 !important;
            margin-left: 0 !important;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            transform: none !important;
        }

        .metric-card:nth-child(3n+2),
        .metric-card:nth-child(3n) {
            transform: none !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        .metric-value {
            font-size: 1.75rem;
        }

        .metric-label {
            font-size: 0.95rem;
        }

        .metric-description {
            font-size: 0.85rem;
        }

        /* Week Analyzer Responsive */
        .week-analyzer-container {
            margin-top: 2rem;
            padding: 1rem 0;
        }

        .analyzer-controls {
            margin-bottom: 2rem;
        }

        .date-range-selector {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .date-input-group {
            width: 100%;
        }

        .date-input {
            width: 100%;
            min-width: auto;
        }

        .analyze-btn {
            width: 100%;
            padding: 1rem;
        }

        .quick-select-buttons {
            flex-direction: column;
            gap: 0.75rem;
        }

        .quick-select-btn {
            width: 100%;
            padding: 0.75rem;
        }

        .results-summary {
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-stat-card {
            padding: 1.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
        }

        .results-details {
            gap: 1.5rem;
        }

        .detail-card {
            padding: 1.5rem;
        }

        .results-header h3 {
            font-size: 1.5rem;
        }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0.75rem;
            }

            .header {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .section {
                padding: 1rem 0.75rem;
            }

            .section h2 {
                font-size: 2rem;
                line-height: 1.1;
            }

            .section p {
                font-size: 0.85rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                gap: 0;
                padding: 0;
                margin-bottom: 1rem;
            }

            .nav-tab {
                min-width: auto;
                padding: 0.75rem 0.875rem;
                font-size: 0.7rem;
            }

            /* Dynamic Dashboard - Small Mobile */
            .dashboard-header h3 {
                font-size: 1.25rem;
            }

            .dashboard-controls {
                flex-direction: column;
            }

            .dashboard-btn {
                width: 100%;
            }

            .metric-card {
                padding: 1.25rem;
                margin-bottom: 1.25rem;
            }

            .metric-value {
                font-size: 1.5rem;
            }

            .metric-label {
                font-size: 0.9rem;
            }

            .metric-description {
                font-size: 0.8rem;
            }

            .week-analyzer-container {
                margin-top: 1.5rem;
                padding: 0.5rem 0;
            }

            .analyzer-controls {
                margin-bottom: 1.5rem;
            }

            .date-range-selector {
                margin-bottom: 1rem;
            }

            .results-summary {
                gap: 0.75rem;
                margin-bottom: 1.5rem;
            }

            .summary-stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .stat-label {
                font-size: 0.7rem;
            }

            .detail-card {
                padding: 1rem;
            }

            .results-header h3 {
                font-size: 1.25rem;
            }

            /* Downloads - Small Mobile */
            .download-card {
                padding: 1.25rem;
            }

            .download-card h4 {
                font-size: 1.1rem;
            }

            .download-meta {
                font-size: 0.7rem;
            }

            .download-card p {
                font-size: 0.85rem;
            }

            /* Patterns Section - Small Mobile */
            .image-card {
                margin-bottom: 2rem;
                padding: 0.5rem 0;
            }

            .image-card img {
                margin-bottom: 1.5rem;
                margin-top: 0.5rem;
            }

            .image-info h3 {
                font-size: 1.5rem;
            }

            .image-info p {
                font-size: 0.9rem;
            }

            .summary-card {
                padding: 1.25rem;
                margin-top: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .summary-card h4 {
                font-size: 0.9rem;
            }

            .summary-card p {
                font-size: 0.8rem;
            }

            .insight-card {
                padding: 1.25rem;
                margin-bottom: 1.25rem;
            }

            .insight-card h4 {
                font-size: 0.95rem;
            }

            .insight-card li {
                font-size: 0.8rem;
            }
        }

        /* Chart Styles */
        .chart-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .chart-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chart-select:hover {
            border-color: var(--primary-color);
        }

        .chart-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .chart-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chart-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .chart-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            position: relative;
            height: 500px;
            overflow: hidden;
        }

        .chart-container canvas {
            max-width: 100% !important;
            max-height: 100% !important;
            width: 100% !important;
            height: 100% !important;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            display: inline-block;
        }

        .chart-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Responsive Modal */
        @media (max-width: 768px) {
            .report-modal {
                width: 95%;
                max-height: 95%;
            }

            .modal-body {
                max-height: 50vh;
                padding: 1rem;
            }

            .modal-header,
            .modal-footer {
                padding: 1rem;
            }
        }

        /* Responsive Chart Controls */
        @media (max-width: 768px) {
            .chart-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                justify-content: space-between;
            }

            .chart-legend {
                gap: 1rem;
            }

            .chart-container {
                height: 400px;
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .chart-container {
                height: 300px;
                padding: 0.75rem;
            }
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }

        .text-right {
            text-align: right;
        }

        .mb-0 {
            margin-bottom: 0;
        }

        .mb-1 {
            margin-bottom: 0.25rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-3 {
            margin-bottom: 0.75rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mt-0 {
            margin-top: 0;
        }

        .mt-1 {
            margin-top: 0.25rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mt-3 {
            margin-top: 0.75rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-main">
                    <h1>Time Series Analysis</h1>
                    <p id="last-updated" class="last-updated">Last Updated: Loading...</p>
                </div>
                <div class="language-toggle">
                    <button id="languageToggle" class="toggle-btn">
                        <span class="toggle-text">Business View</span>
                    </button>
                </div>
            </div>

        </div>



        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="overview">
                Overview
            </button>
            <button class="nav-tab" data-tab="analysis">
                Analysis
            </button>
            <button class="nav-tab" data-tab="patterns">
                Patterns
            </button>
            <button class="nav-tab" data-tab="intelligence">
                Intelligence
            </button>
            <button class="nav-tab" data-tab="downloads">
                Downloads
            </button>
            <button class="nav-tab" data-tab="week-analyzer">
                Week Analyzer
            </button>
        </div>

        <!-- Overview Section -->
        <div id="overview" class="content-section active">
            <div class="section">
                <h2>Your Restaurant's Growth Story</h2>
                <p>Simple breakdown of how your restaurant is performing and growing over time.</p>

                <div class="gallery">
                    <div class="image-card featured" data-image="01_professional_time_series.png">
                        <img src="01_professional_time_series.png" alt="Professional Time Series Analysis"
                            loading="lazy">
                        <div class="image-info">
                            <h3>Complete Sales Journey Analysis</h3>
                            <div class="filename">01_professional_time_series.png</div>

                            <div class="summary-card">
                                <h4>TL;DR Summary</h4>
                                <p id="overview-tldr">Great news! Your restaurant is growing steadily. Sales went from
                                    $40,000 to $57,000 per week. You're growing by about $8,500 every year. Your busy
                                    and slow seasons vary by about $10,000. This means you can plan ahead and know what
                                    to expect!</p>
                            </div>

                            <p id="overview-analysis"><strong>Analysis Summary:</strong> This chart shows your
                                restaurant's performance in three simple parts. The blue line shows your actual sales
                                growing from $40,000 to $57,000 per week. The green line shows you're growing by about
                                $8,500 every year. The red line shows your busy and slow seasons (without the growth
                                trend), so you can see your seasonal patterns clearly.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Analysis Section -->
        <div id="analysis" class="content-section">
            <div class="section">
                <h2>Understanding Your Sales Patterns</h2>
                <p>Clear explanation of what drives your busy and slow seasons, and how to plan for them.</p>

                <div class="gallery">
                    <div class="image-card featured" data-image="03_trend_adjusted_peaks.png">
                        <img src="03_trend_adjusted_peaks.png" alt="Time Series Decomposition Analysis" loading="lazy">
                        <div class="image-info">
                            <h3>Complete Sales Decomposition Analysis</h3>
                            <div class="filename">03_trend_adjusted_peaks.png</div>

                            <div class="summary-card">
                                <h4>TL;DR Summary</h4>
                                <p id="analysis-tldr">Your sales break down into three simple parts: 85% comes from
                                    steady growth ($8,500 per year), 15% comes from busy and slow seasons, and less than
                                    5% is just random ups and downs. This means your business is very predictable!</p>
                            </div>

                            <div class="insights-grid">
                                <div class="insight-card" id="analysis-business-insights">
                                    <h4>What This Means for You</h4>
                                    <ul>
                                        <li><strong>Strong Growth:</strong> You've grown by $17,000 over 2 years</li>
                                        <li><strong>Seasonal Patterns:</strong> Sales vary by $10,000 with seasons</li>
                                        <li><strong>Planning Time:</strong> You need 3 weeks to prepare for busy times
                                        </li>
                                        <li><strong>Staffing Needs:</strong> Plan for 25-30% more staff during peaks
                                        </li>
                                    </ul>
                                </div>

                                <div class="insight-card" id="analysis-statistical">
                                    <h4>How Your Sales Break Down</h4>
                                    <ul>
                                        <li><strong>Steady Growth:</strong> 85% of your sales come from growth</li>
                                        <li><strong>Seasonal Patterns:</strong> 15% comes from busy/slow seasons</li>
                                        <li><strong>Random Variation:</strong> Less than 5% is unpredictable</li>
                                        <li><strong>Reliability:</strong> These patterns are very predictable</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patterns Section -->
        <div id="patterns" class="content-section">
            <div class="section">
                <h2>Your Busy and Slow Seasons</h2>
                <p>Simple guide to understanding when you'll be busy and when you'll be slow.</p>

                <div class="gallery">
                    <div class="image-card" data-image="04_enhanced_sales_heatmap.png">
                        <img src="04_enhanced_sales_heatmap.png" alt="Detrended Sales Intensity Heatmap" loading="lazy">
                        <div class="image-info">
                            <h3>Detrended Sales Intensity Heatmap</h3>
                            <div class="filename">04_enhanced_sales_heatmap.png</div>

                            <div class="summary-card">
                                <h4>TL;DR Summary</h4>
                                <p id="patterns-tldr">This chart shows your busy and slow seasons clearly. Dark blue
                                    areas are your busiest times (October/November and April/May). Light blue areas are
                                    your quietest times (January/February and July/August). You can see these patterns
                                    coming 8-12 weeks ahead, so you can plan ahead!</p>
                            </div>

                            <div class="insights-grid">
                                <div class="insight-card" id="patterns-peak-analysis">
                                    <h4>Your Busiest Times</h4>
                                    <ul>
                                        <li><strong>October & November:</strong> Your biggest rush of the year</li>
                                        <li><strong>April & May:</strong> Your second busiest time</li>
                                        <li><strong>Reliability:</strong> These patterns are very consistent</li>
                                        <li><strong>Planning:</strong> Start preparing 8-12 weeks ahead</li>
                                    </ul>
                                </div>

                                <div class="insight-card" id="patterns-trough-analysis">
                                    <h4>Your Quietest Times</h4>
                                    <ul>
                                        <li><strong>January & February:</strong> Your quietest months</li>
                                        <li><strong>July & August:</strong> Your second quietest time</li>
                                        <li><strong>Consistency:</strong> These patterns are very predictable</li>
                                        <li><strong>Opportunity:</strong> Use these times to save money and plan</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Intelligence Section -->
        <div id="intelligence" class="content-section">
            <div class="section">
                <h2>Business Intelligence Summary</h2>
                <p>Comprehensive analysis of your restaurant's performance with actionable insights for strategic
                    decision making.</p>

                <div class="dynamic-dashboard">
                    <div class="dashboard-header">
                        <h3 id="dashboard-title">Enhanced Critical Business Metrics Dashboard</h3>
                        <div class="dashboard-controls">
                            <button id="refreshMetrics" class="dashboard-btn">
                                Refresh
                            </button>
                            <button id="exportMetrics" class="dashboard-btn">
                                Export
                            </button>
                        </div>
                    </div>

                    <div class="metrics-grid" id="metricsGrid">
                        <!-- Dynamic metrics will be populated here -->
                    </div>

                    <div class="summary-card">
                        <h4>TL;DR Summary</h4>
                        <p id="intelligence-tldr">Your restaurant is growing strong! $177.86 weekly growth, 66.5%
                            seasonal patterns, 11 peak weeks per year, and manageable 16.3% volatility. You can reliably
                            forecast 12 weeks ahead.</p>
                    </div>

                    <div class="insights-grid">
                        <div class="insight-card" id="intelligence-strategic">
                            <h4>Strategic Business Insights</h4>
                            <ul>
                                <li><strong>Investment Confidence:</strong> Growth is statistically significant</li>
                                <li><strong>Seasonal Marketing:</strong> 66.5% seasonal strength</li>
                                <li><strong>Resource Planning:</strong> 11 peak weeks require 25-30% more staffing</li>
                                <li><strong>Cash Flow Management:</strong> $48,673 average weekly sales</li>
                            </ul>
                        </div>

                        <div class="insight-card" id="intelligence-actions">
                            <h4>Immediate Action Items</h4>
                            <ul>
                                <li><strong>Peak Week Preparation:</strong> Start planning 3 weeks before peaks</li>
                                <li><strong>Seasonal Menu Planning:</strong> Develop seasonal specials</li>
                                <li><strong>Marketing Calendar:</strong> Schedule campaigns for pre-peak periods</li>
                                <li><strong>Inventory Management:</strong> Stock up 20-25% during peak seasons</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Downloads Section -->
        <div id="downloads" class="content-section">
            <div class="download-section">
                <h2>Download Analysis Reports</h2>
                <p>Download comprehensive analysis reports and documentation for detailed review and strategic planning.
                </p>



                <div class="download-grid">
                    <div class="download-card">
                        <h4>Core Time Series Analysis</h4>
                        <p>Complete sales journey analysis with trend, seasonal, and detrended components breakdown.</p>
                        <div class="download-actions">
                            <button class="download-btn preview-btn"
                                data-report="TIME_SERIES_DECOMPOSITION_ANALYSIS.md">
                                Preview Report
                            </button>
                            <a href="TIME_SERIES_DECOMPOSITION_ANALYSIS.md" download="Core_Time_Series_Analysis.md"
                                class="download-btn">
                                Download
                            </a>
                        </div>
                    </div>

                    <div class="download-card">
                        <h4>Advanced Decomposition Analysis</h4>
                        <p>Statistical decomposition revealing fundamental components driving sales patterns.</p>
                        <div class="download-actions">
                            <button class="download-btn preview-btn"
                                data-report="TREND_DECOMPOSITION_BUSINESS_ANALYSIS.md">
                                Preview Report
                            </button>
                            <a href="TREND_DECOMPOSITION_BUSINESS_ANALYSIS.md"
                                download="Advanced_Decomposition_Analysis.md" class="download-btn">
                                Download
                            </a>
                        </div>
                    </div>

                    <div class="download-card">
                        <h4>Detrended Sales Heatmap Analysis</h4>
                        <p>True seasonal patterns revealed by removing growth bias from sales data.</p>
                        <div class="download-actions">
                            <button class="download-btn preview-btn" data-report="DETRENDED_SALES_HEATMAP_ANALYSIS.md">
                                Preview Report
                            </button>
                            <a href="DETRENDED_SALES_HEATMAP_ANALYSIS.md" download="Detrended_Sales_Heatmap_Analysis.md"
                                class="download-btn">
                                Download
                            </a>
                        </div>
                    </div>

                    <div class="download-card">
                        <h4>Monthly Sales Patterns Analysis</h4>
                        <p>Growth vs seasonality comparison with original vs detrended sales analysis.</p>
                        <div class="download-actions">
                            <button class="download-btn preview-btn" data-report="MONTHLY_SALES_PATTERNS_ANALYSIS.md">
                                Preview Report
                            </button>
                            <a href="MONTHLY_SALES_PATTERNS_ANALYSIS.md" download="Monthly_Sales_Patterns_Analysis.md"
                                class="download-btn">
                                Download
                            </a>
                        </div>
                    </div>

                    <div class="download-card">
                        <h4>Business Intelligence Summary</h4>
                        <p>Enhanced business intelligence dashboard with actionable strategic insights.</p>
                        <div class="download-actions">
                            <button class="download-btn preview-btn"
                                data-report="BUSINESS_INTELLIGENCE_SUMMARY_ANALYSIS.md">
                                Preview Report
                            </button>
                            <a href="BUSINESS_INTELLIGENCE_SUMMARY_ANALYSIS.md"
                                download="Business_Intelligence_Summary.md" class="download-btn">
                                Download
                            </a>
                        </div>
                    </div>

                    <div class="download-card">
                        <h4>Business Planning Guide</h4>
                        <p>Comprehensive business planning recommendations and strategic guidance.</p>
                        <div class="download-actions">
                            <button class="download-btn preview-btn" data-report="BUSINESS_PLANNING_GUIDE.md">
                                Preview Report
                            </button>
                            <a href="BUSINESS_PLANNING_GUIDE.md" download="Business_Planning_Guide.md"
                                class="download-btn">
                                Download
                            </a>
                        </div>
                    </div>




                </div>
            </div>
        </div>

        <!-- Week Analyzer Section -->
        <div id="week-analyzer" class="content-section">
            <div class="section">
                <h2>Week Performance Analyzer</h2>
                <p id="analyzer-description">Select any date to see if that week was busy or slow compared to your
                    restaurant's average performance.</p>

                <div class="week-analyzer-container">
                    <div class="analyzer-controls">
                        <div class="date-range-selector">
                            <div class="date-input-group">
                                <label for="week-date">Select Week</label>
                                <input type="date" id="week-date" class="date-input">
                            </div>
                            <button id="analyze-weeks" class="analyze-btn">Analyze Week</button>
                        </div>
                        <div class="quick-select-buttons">
                            <button class="quick-select-btn" data-offset="0">This Week</button>
                            <button class="quick-select-btn" data-offset="1">Last Week</button>
                            <button class="quick-select-btn" data-offset="2">2 Weeks Ago</button>
                            <button class="quick-select-btn" data-offset="4">4 Weeks Ago</button>
                        </div>
                    </div>

                    <div id="analyzer-results" class="analyzer-results" style="display: none;">
                        <div class="results-header">
                            <h3 id="results-title">Analysis Results</h3>
                            <div class="results-period" id="results-period"></div>
                        </div>

                        <div class="results-summary">
                            <div class="summary-stat-card">
                                <div class="stat-label" id="stat-label-sales">Week Sales</div>
                                <div class="stat-value" id="stat-average">$0</div>
                                <div class="stat-comparison" id="stat-average-comp"></div>
                            </div>
                            <div class="summary-stat-card">
                                <div class="stat-label" id="stat-label-diff">Difference</div>
                                <div class="stat-value" id="stat-total">$0</div>
                                <div class="stat-comparison" id="stat-total-comp"></div>
                            </div>
                            <div class="summary-stat-card">
                                <div class="stat-label" id="stat-label-rating">Performance Rating</div>
                                <div class="stat-value" id="stat-rating">-</div>
                                <div class="stat-comparison" id="stat-rating-comp"></div>
                            </div>
                            <div class="summary-stat-card" id="stat-card-zscore" style="display: none;">
                                <div class="stat-label" id="stat-label-zscore">Z-Score</div>
                                <div class="stat-value" id="stat-zscore">0.00</div>
                                <div class="stat-comparison" id="stat-zscore-comp"></div>
                            </div>
                        </div>

                        <div class="results-details">
                            <div class="detail-card">
                                <h4 id="detail-title-business">What This Means</h4>
                                <h4 id="detail-title-scientific" style="display: none;">Statistical Analysis</h4>
                                <div id="detail-content-business">
                                    <p>Your selected period shows how your restaurant performed compared to your overall
                                        average.</p>
                                </div>
                                <div id="detail-content-scientific" style="display: none;">
                                    <p>Statistical analysis of the selected period relative to the full dataset
                                        distribution.</p>
                                </div>
                            </div>

                            <div class="detail-card">
                                <h4 id="historical-context-title">Historical Context</h4>
                                <div id="historical-context" class="historical-context"></div>
                            </div>

                            <div class="detail-card">
                                <h4 id="percentile-title">Percentile Ranking</h4>
                                <div id="percentile-info" class="percentile-info"></div>
                            </div>
                        </div>
                    </div>

                    <div id="analyzer-loading" class="analyzer-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Analyzing your data...</p>
                    </div>

                    <div id="analyzer-error" class="analyzer-error" style="display: none;">
                        <p>Unable to load data. Please ensure weekly_sales_data.json is available.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Preview Modal -->
        <div id="reportModal" class="modal">
            <div class="modal-content report-modal">
                <div class="modal-header">
                    <h3 id="reportTitle">Report Preview</h3>
                    <span class="close" id="closeReportModal">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="reportContent" class="report-content">
                        <div class="loading">Loading report...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="download-btn" id="downloadFromPreview">
                        View Raw Text
                    </button>
                    <button class="chart-btn" id="closeReportBtn">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for full-screen images -->
    <div id="imageModal" class="modal">
        <div class="modal-header image-modal-header">
            <h3 id="imageTitle">Image Preview</h3>
            <div class="image-modal-controls">
                <button type="button" class="download-btn" id="downloadImage">
                    Download
                </button>
                <button type="button" class="close" id="closeImageModal">&times;</button>
            </div>
        </div>
        <div class="modal-body image-modal-body">
            <img class="modal-content" id="modalImage" alt="Full-size image">
        </div>
    </div>

    <script>
        // Modern JavaScript with enhanced functionality
        class DashboardApp {
            constructor() {
                this.modal = document.getElementById('imageModal');
                this.modalImg = document.getElementById('modalImage');
                this.navTabs = document.querySelectorAll('.nav-tab');
                this.contentSections = document.querySelectorAll('.content-section');
                this.imageCards = document.querySelectorAll('.image-card');

                this.init();
            }

            init() {
                this.setupNavigation();
                this.setupModal();
                this.setupImageCards();
                this.setupAnimations();
                this.setupKeyboardShortcuts();
            }

            setupNavigation() {
                this.navTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetTab = tab.getAttribute('data-tab');
                        this.switchTab(targetTab);
                    });
                });
            }

            switchTab(targetTab) {
                // Update active tab
                this.navTabs.forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.getAttribute('data-tab') === targetTab) {
                        tab.classList.add('active');
                    }
                });

                // Update active content section
                this.contentSections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === targetTab) {
                        section.classList.add('active');
                    }
                });

                // Smooth scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            setupModal() {
                // Close modal when clicking the X
                document.getElementById('closeImageModal').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.closeModal();
                });

                // Download image button
                document.getElementById('downloadImage').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Download button clicked');
                    this.downloadImage();
                });

                // Close modal when clicking outside the image
                this.modal.addEventListener('click', (event) => {
                    if (event.target === this.modal) {
                        this.closeModal();
                    }
                });

                // Close modal with Escape key
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        this.closeModal();
                    }
                });
            }

            setupImageCards() {
                this.imageCards.forEach(card => {
                    // Prevent all default behaviors on the card
                    card.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        console.log('Image card clicked');

                        // Get image source from img tag or data attribute
                        const img = card.querySelector('img');
                        const dataImage = card.getAttribute('data-image');

                        let imageSrc = '';
                        let imageAlt = '';

                        if (img) {
                            imageSrc = img.src;
                            imageAlt = img.alt;
                        } else if (dataImage) {
                            imageSrc = dataImage;
                            imageAlt = dataImage;
                        }

                        if (imageSrc) {
                            console.log('Opening modal for image:', imageSrc);
                            this.openModal(imageSrc, imageAlt);
                        } else {
                            console.error('No image source found for card');
                        }
                    });

                    // Prevent any link clicks within the card
                    const links = card.querySelectorAll('a');
                    links.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            console.log('Link click prevented');
                            return false;
                        });
                    });

                    // Prevent any button clicks within the card (except our own)
                    const buttons = card.querySelectorAll('button');
                    buttons.forEach(button => {
                        if (!button.id.includes('download') && !button.id.includes('close')) {
                            button.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                console.log('Button click prevented');
                                return false;
                            });
                        }
                    });

                    // Add hover effects
                    card.addEventListener('mouseenter', () => {
                        card.style.transform = 'translateY(-8px)';
                    });

                    card.addEventListener('mouseleave', () => {
                        card.style.transform = 'translateY(0)';
                    });
                });
            }

            openModal(src, alt) {
                this.modalImg.src = src;
                this.modalImg.alt = alt;

                // Set image title
                const imageTitle = document.getElementById('imageTitle');
                const filename = src.split('/').pop(); // Get filename from path
                imageTitle.textContent = filename || 'Image Preview';

                this.modal.style.display = 'block';

                // Add show class for animation
                setTimeout(() => {
                    this.modal.classList.add('show');
                }, 10);

                // Reset zoom
                this.modalImg.style.transform = 'scale(1)';
            }

            downloadImage() {
                const img = this.modalImg;
                const filename = img.src.split('/').pop() || 'image.png';

                console.log('Downloading image:', filename);
                console.log('Image src:', img.src);
                console.log('Image natural size:', img.naturalWidth, 'x', img.naturalHeight);

                // Check if image is loaded
                if (!img.complete || img.naturalWidth === 0) {
                    console.log('Image not fully loaded, waiting...');
                    img.onload = () => this.downloadImage();
                    return;
                }

                // Method 1: Fetch and download (most reliable)
                this.downloadImageViaFetch(img.src, filename);
            }

            async downloadImageViaFetch(imageSrc, filename) {
                try {
                    console.log('Attempting fetch download for:', filename);

                    // Fetch the image as blob
                    const response = await fetch(imageSrc);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const blob = await response.blob();
                    console.log('Blob size:', blob.size, 'bytes');

                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';

                    // Trigger download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Cleanup
                    window.URL.revokeObjectURL(url);

                    console.log('Fetch download completed for:', filename);
                    showNotification('Image downloaded successfully!', 'success');

                } catch (error) {
                    console.error('Fetch download failed:', error);

                    // Method 2: Canvas fallback
                    this.downloadImageViaCanvas(imageSrc, filename);
                }
            }

            downloadImageViaCanvas(imageSrc, filename) {
                try {
                    console.log('Attempting canvas download for:', filename);

                    const img = this.modalImg;
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Set canvas size to image size
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;

                    console.log('Canvas size set to:', canvas.width, 'x', canvas.height);

                    // Draw image on canvas
                    ctx.drawImage(img, 0, 0);

                    // Convert to blob and download
                    canvas.toBlob((blob) => {
                        if (blob) {
                            const url = window.URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = filename;
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);

                            console.log('Canvas download completed for:', filename);
                            showNotification('Image downloaded successfully!', 'success');
                        } else {
                            console.error('Failed to create blob from canvas');
                            this.showManualDownloadInstructions(filename);
                        }
                    }, 'image/png', 1.0);

                } catch (error) {
                    console.error('Canvas download failed:', error);
                    this.showManualDownloadInstructions(filename);
                }
            }

            showManualDownloadInstructions(filename) {
                showNotification('Automatic download failed. Right-click the image and select "Save image as..."', 'error');

                // Show a more detailed message in the modal
                const modal = document.getElementById('imageModal');
                const content = modal.querySelector('.modal-body');

                const instructionDiv = document.createElement('div');
                instructionDiv.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 2rem;
                    border-radius: var(--radius-lg);
                    text-align: center;
                    z-index: 1003;
                    max-width: 400px;
                `;

                instructionDiv.innerHTML = `
                    <h3>Manual Download Required</h3>
                    <p>To download <strong>${filename}</strong>:</p>
                    <ol style="text-align: left; margin: 1rem 0;">
                        <li>Right-click on the image</li>
                        <li>Select "Save image as..."</li>
                        <li>Choose your download location</li>
                        <li>Click "Save"</li>
                    </ol>
                    <button onclick="this.parentElement.remove()" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius-md); cursor: pointer;">
                        Got it
                    </button>
                `;

                content.appendChild(instructionDiv);

                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (instructionDiv.parentElement) {
                        instructionDiv.remove();
                    }
                }, 10000);
            }

            closeModal() {
                this.modal.classList.remove('show');
                setTimeout(() => {
                    this.modal.style.display = 'none';
                }, 300);
            }

            setupAnimations() {
                // Intersection Observer for fade-in animations
                const observerOptions = {
                    threshold: 0.1,
                    rootMargin: '0px 0px -50px 0px'
                };

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.style.opacity = '1';
                            entry.target.style.transform = 'translateY(0)';
                        }
                    });
                }, observerOptions);

                // Observe all cards and sections
                document.querySelectorAll('.image-card, .download-card, .stat-card').forEach(el => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(20px)';
                    el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                    observer.observe(el);
                });
            }

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (event) => {
                    // Ctrl/Cmd + K to focus search (if we add one)
                    if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                        event.preventDefault();
                        // Future search functionality
                    }

                    // Number keys to switch tabs
                    const tabKeys = ['1', '2', '3', '4', '5'];
                    if (tabKeys.includes(event.key)) {
                        const tabIndex = parseInt(event.key) - 1;
                        if (this.navTabs[tabIndex]) {
                            this.switchTab(this.navTabs[tabIndex].getAttribute('data-tab'));
                        }
                    }
                });
            }
        }

        // Week Analyzer Class
        class WeekAnalyzer {
            constructor() {
                this.salesData = null;
                this.statistics = null;
                this.isBusinessMode = true;
                this.lastResults = null;
                this.lastSelectedDate = null;
                this.lastIsFutureDate = false;
                this.lastMatchType = null;
                this.lastWeekData = null;
                this.init();
            }

            async init() {
                await this.loadData();
                this.setupEventListeners();
                this.setupQuickSelect();
                // Set initial language mode and update labels
                if (window.languageToggle) {
                    this.isBusinessMode = window.languageToggle.isBusinessMode;
                }
                this.updateStatLabels();
                this.updateLanguageMode();
            }

            async loadData() {
                try {
                    // Add cache-busting parameter to ensure fresh data
                    const cacheBuster = new Date().getTime();
                    const response = await fetch(`weekly_sales_data.json?t=${cacheBuster}`, {
                        cache: 'no-cache'
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    console.log('Raw JSON data:', data);

                    // Validate data structure
                    if (!data || !data.data || !Array.isArray(data.data)) {
                        throw new Error('Invalid JSON structure: missing or invalid "data" array');
                    }
                    if (!data.statistics) {
                        throw new Error('Invalid JSON structure: missing "statistics" object');
                    }

                    this.salesData = data.data.map(item => ({
                        date: new Date(item.date),
                        value: parseFloat(item.value)
                    })).filter(item => !isNaN(item.date.getTime()) && !isNaN(item.value));

                    this.statistics = data.statistics;
                    console.log('Sales data loaded:', this.salesData.length, 'weeks');
                    console.log('Statistics:', this.statistics);

                    if (this.salesData.length === 0) {
                        throw new Error('No valid data found in JSON file');
                    }

                    document.getElementById('analyzer-error').style.display = 'none';
                } catch (error) {
                    console.error('Error loading sales data:', error);
                    const errorDiv = document.getElementById('analyzer-error');
                    errorDiv.innerHTML = `
                        <p><strong>Error loading data file.</strong></p>
                        <p>Error: ${error.message}</p>
                        <p>Please ensure weekly_sales_data.json exists and is valid JSON.</p>
                        <p>To generate it, run in R or RStudio:<br>
                        <code>source("export_weekly_data_json.R")</code></p>
                        <p>Or from command line:<br>
                        <code>Rscript export_weekly_data_json.R</code></p>
                    `;
                    errorDiv.style.display = 'block';
                }
            }

            setupEventListeners() {
                document.getElementById('analyze-weeks').addEventListener('click', () => {
                    this.analyzePeriod();
                });

                // Listen for language toggle changes
                if (window.languageToggle) {
                    const observer = new MutationObserver(() => {
                        this.isBusinessMode = window.languageToggle.isBusinessMode;
                        this.updateLanguageMode();
                    });
                    const toggleBtn = document.querySelector('.toggle-btn');
                    if (toggleBtn) {
                        observer.observe(toggleBtn, { attributes: true, attributeFilter: ['class'] });
                    }
                }
            }

            setupQuickSelect() {
                document.querySelectorAll('.quick-select-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const offset = parseInt(btn.getAttribute('data-offset'));
                        this.setQuickDate(offset);
                    });
                });
            }

            setQuickDate(weeksAgo) {
                if (!this.salesData || this.salesData.length === 0) return;

                // Get the most recent week in the data
                const lastWeek = new Date(this.salesData[this.salesData.length - 1].date);
                const targetDate = new Date(lastWeek);
                targetDate.setDate(targetDate.getDate() - (weeksAgo * 7));

                // Find the closest week in the data
                let closestWeek = this.salesData[0];
                let minDiff = Math.abs(targetDate - closestWeek.date);

                this.salesData.forEach(item => {
                    const diff = Math.abs(targetDate - item.date);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestWeek = item;
                    }
                });

                document.getElementById('week-date').value = this.formatDateForInput(closestWeek.date);
            }

            formatDateForInput(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            analyzePeriod() {
                const weekDate = document.getElementById('week-date').value;

                if (!weekDate) {
                    alert('Please select a date');
                    return;
                }

                if (!this.salesData || !this.statistics) {
                    alert('Data not loaded. Please refresh the page.');
                    return;
                }

                const selectedDate = new Date(weekDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isFutureDate = selectedDate > today;

                // Find the best historical match
                let closestWeek = null;
                let matchType = 'exact'; // 'exact', 'same_week_of_year', 'closest'

                // First, try to find exact match (within 3 days)
                let exactMatch = null;
                let exactDiff = Infinity;
                this.salesData.forEach(item => {
                    const diff = Math.abs(selectedDate - item.date);
                    if (diff < exactDiff && diff <= 3 * 24 * 60 * 60 * 1000) {
                        exactDiff = diff;
                        exactMatch = item;
                    }
                });

                if (exactMatch) {
                    closestWeek = exactMatch;
                    matchType = 'exact';
                } else {
                    // Try to find same week of year from previous years (better for seasonal predictions)
                    const selectedWeek = this.getWeekOfYear(selectedDate);
                    const selectedMonth = selectedDate.getMonth();

                    let sameWeekMatches = this.salesData.filter(item => {
                        const itemWeek = this.getWeekOfYear(item.date);
                        const itemMonth = item.date.getMonth();
                        // Match same week of year and same month (within 1 month for flexibility)
                        return Math.abs(itemWeek - selectedWeek) <= 1 &&
                            Math.abs(itemMonth - selectedMonth) <= 1;
                    });

                    if (sameWeekMatches.length > 0) {
                        // Use the average of matching weeks for better prediction
                        const avgValue = sameWeekMatches.reduce((sum, item) => sum + item.value, 0) / sameWeekMatches.length;
                        // Find the week closest to the average
                        sameWeekMatches.sort((a, b) => Math.abs(a.value - avgValue) - Math.abs(b.value - avgValue));
                        closestWeek = {
                            date: selectedDate, // Use selected date for display
                            value: avgValue,
                            isPrediction: true,
                            basedOnWeeks: sameWeekMatches
                        };
                        matchType = 'same_week_of_year';
                    } else {
                        // Fallback: find closest historical week
                        let closestHistoricalWeek = null;
                        let minDiff = Infinity;
                        this.salesData.forEach(item => {
                            const diff = Math.abs(selectedDate - item.date);
                            if (diff < minDiff) {
                                minDiff = diff;
                                closestHistoricalWeek = item;
                            }
                        });
                        if (closestHistoricalWeek) {
                            if (isFutureDate || minDiff > 3 * 24 * 60 * 60 * 1000) {
                                // Create a prediction object for future dates or dates far from data
                                closestWeek = {
                                    date: selectedDate,
                                    value: closestHistoricalWeek.value,
                                    isPrediction: true,
                                    basedOnWeeks: [closestHistoricalWeek]
                                };
                            } else {
                                closestWeek = closestHistoricalWeek;
                            }
                        }
                        matchType = 'closest';
                    }
                }

                if (!closestWeek) {
                    alert('No data available. Please ensure sales data is loaded.');
                    return;
                }

                // Show loading
                const loadingDiv = document.getElementById('analyzer-loading');
                const resultsDiv = document.getElementById('analyzer-results');
                const errorDiv = document.getElementById('analyzer-error');

                loadingDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';

                // Set a timeout to prevent infinite loading
                const timeoutId = setTimeout(() => {
                    loadingDiv.style.display = 'none';
                    errorDiv.innerHTML = '<p><strong>Analysis timed out.</strong> Please try again or refresh the page.</p>';
                    errorDiv.style.display = 'block';
                    console.error('Analysis timeout after 10 seconds');
                }, 10000);

                // Process analysis with error handling
                try {
                    // Simulate async processing (but actually do it immediately)
                    setTimeout(() => {
                        try {
                            clearTimeout(timeoutId);
                            const results = this.calculateStatistics(closestWeek);

                            if (!results) {
                                throw new Error('Failed to calculate statistics');
                            }

                            // Store results for language mode updates
                            this.lastResults = results;
                            this.lastSelectedDate = selectedDate;
                            this.lastIsFutureDate = isFutureDate;
                            this.lastMatchType = matchType;
                            this.lastWeekData = closestWeek;

                            this.displayResults(results, selectedDate, isFutureDate, matchType, closestWeek);
                            loadingDiv.style.display = 'none';
                            resultsDiv.style.display = 'block';
                        } catch (error) {
                            clearTimeout(timeoutId);
                            console.error('Error during analysis:', error);
                            loadingDiv.style.display = 'none';
                            errorDiv.innerHTML = `<p><strong>Error during analysis:</strong> ${error.message}</p><p>Please try again or refresh the page.</p>`;
                            errorDiv.style.display = 'block';
                        }
                    }, 100); // Reduced from 300ms to 100ms for faster response
                } catch (error) {
                    clearTimeout(timeoutId);
                    console.error('Error setting up analysis:', error);
                    loadingDiv.style.display = 'none';
                    errorDiv.innerHTML = `<p><strong>Error:</strong> ${error.message}</p>`;
                    errorDiv.style.display = 'block';
                }
            }

            getWeekOfYear(date) {
                // Get ISO week number
                const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            }

            calculateStatistics(weekData) {
                try {
                    if (!weekData) {
                        throw new Error('No week data provided');
                    }

                    if (!this.salesData || !this.statistics) {
                        throw new Error('Sales data or statistics not loaded');
                    }

                    const weekValue = weekData.value;
                    const weekDate = weekData.date;

                    if (typeof weekValue !== 'number' || isNaN(weekValue)) {
                        throw new Error('Invalid week value');
                    }

                    if (!(weekDate instanceof Date) || isNaN(weekDate.getTime())) {
                        throw new Error('Invalid week date');
                    }

                    const isPrediction = weekData.isPrediction || false;
                    const basedOnWeeks = weekData.basedOnWeeks || (weekData.basedOnWeek ? [weekData.basedOnWeek] : null);

                    // Calculate z-score (how many standard deviations from the mean)
                    const zScore = (weekValue - this.statistics.mean) / this.statistics.sd;

                    // Calculate percentile
                    const allValues = this.salesData.map(item => item.value).sort((a, b) => a - b);
                    const percentile = (allValues.filter(v => v <= weekValue).length / allValues.length) * 100;

                    // Determine performance rating
                    let rating, ratingClass;
                    if (zScore > 1.5) {
                        rating = 'Exceptionally Busy';
                        ratingClass = 'positive';
                    } else if (zScore > 0.5) {
                        rating = 'Busy';
                        ratingClass = 'positive';
                    } else if (zScore > -0.5) {
                        rating = 'Average';
                        ratingClass = '';
                    } else if (zScore > -1.5) {
                        rating = 'Slow';
                        ratingClass = 'negative';
                    } else {
                        rating = 'Very Slow';
                        ratingClass = 'negative';
                    }

                    // Find similar weeks (within 5% of value)
                    const similarWeeks = this.salesData.filter(item => {
                        const diff = Math.abs(item.value - weekValue) / weekValue;
                        return diff <= 0.05;
                    }).slice(0, 5);

                    // Find previous and next weeks for context (only if exact match)
                    let previousWeek = null;
                    let nextWeek = null;
                    if (!isPrediction) {
                        const weekIndex = this.salesData.findIndex(item => item.date.getTime() === weekDate.getTime());
                        previousWeek = weekIndex > 0 ? this.salesData[weekIndex - 1] : null;
                        nextWeek = weekIndex < this.salesData.length - 1 ? this.salesData[weekIndex + 1] : null;
                    }

                    return {
                        weekValue,
                        weekDate,
                        zScore,
                        percentile,
                        rating,
                        ratingClass,
                        similarWeeks,
                        previousWeek,
                        nextWeek,
                        isPrediction,
                        basedOnWeeks,
                        comparison: {
                            valueDiff: weekValue - this.statistics.mean,
                            percentDiff: ((weekValue - this.statistics.mean) / this.statistics.mean) * 100
                        }
                    };
                } catch (error) {
                    console.error('Error in calculateStatistics:', error);
                    throw error; // Re-throw to be caught by caller
                }
            }

            displayResults(results, selectedDate, isFutureDate, matchType, weekData) {
                if (!results) {
                    alert('No data found for the selected week');
                    return;
                }

                // Helper function to safely get element
                const getElement = (id) => {
                    const el = document.getElementById(id);
                    if (!el) {
                        console.error(`Element with id "${id}" not found`);
                    }
                    return el;
                };

                // Update header with prediction indicator
                let periodText = `Week of ${this.formatDate(selectedDate)}`;
                if (results.isPrediction) {
                    periodText += ' (Predicted)';
                }
                const resultsPeriod = getElement('results-period');
                if (resultsPeriod) resultsPeriod.textContent = periodText;

                // Update summary stats
                const statAverage = getElement('stat-average');
                if (statAverage) statAverage.textContent = this.formatCurrency(results.weekValue);
                let salesCompText = this.isBusinessMode
                    ? `${results.comparison.percentDiff >= 0 ? '+' : ''}${results.comparison.percentDiff.toFixed(1)}% ${results.comparison.percentDiff >= 0 ? 'above' : 'below'} your average`
                    : `${results.comparison.percentDiff >= 0 ? '+' : ''}${results.comparison.percentDiff.toFixed(1)}% deviation from mean`;
                if (results.isPrediction) {
                    salesCompText += this.isBusinessMode ? ' (expected)' : ' (predicted)';
                }
                const statAverageComp = getElement('stat-average-comp');
                if (statAverageComp) {
                    statAverageComp.textContent = salesCompText;
                    statAverageComp.className = `stat-comparison ${results.comparison.percentDiff >= 0 ? 'positive' : 'negative'}`;
                }

                const statTotal = getElement('stat-total');
                if (statTotal) statTotal.textContent = this.formatCurrency(Math.abs(results.comparison.valueDiff));
                let diffCompText = this.isBusinessMode
                    ? `${results.comparison.valueDiff >= 0 ? '+' : '-'}${this.formatCurrency(Math.abs(results.comparison.valueDiff))} ${results.comparison.valueDiff >= 0 ? 'more' : 'less'} than average`
                    : `${results.comparison.valueDiff >= 0 ? '+' : ''}${this.formatCurrency(results.comparison.valueDiff)} deviation from `;
                if (results.isPrediction) {
                    diffCompText += this.isBusinessMode ? ' (expected)' : ' (predicted)';
                }
                const statTotalComp = getElement('stat-total-comp');
                if (statTotalComp) {
                    statTotalComp.textContent = diffCompText;
                    statTotalComp.className = `stat-comparison ${results.comparison.valueDiff >= 0 ? 'positive' : 'negative'}`;
                }

                const statRating = getElement('stat-rating');
                if (statRating) {
                    // Use business-friendly rating text
                    const ratingText = this.isBusinessMode
                        ? this.getBusinessRating(results.rating)
                        : results.rating;
                    statRating.textContent = ratingText;
                }
                let ratingCompText = this.isBusinessMode
                    ? `${results.isPrediction ? 'Expected' : 'Actual'} performance level`
                    : `Z-score: ${results.zScore.toFixed(2)}`;
                if (results.isPrediction && !this.isBusinessMode) {
                    ratingCompText += ' (based on historical data)';
                }
                const statRatingComp = getElement('stat-rating-comp');
                if (statRatingComp) statRatingComp.textContent = ratingCompText;

                // Only update Z-Score if in scientific mode (card is hidden in business mode)
                if (!this.isBusinessMode) {
                    const statZscore = getElement('stat-zscore');
                    if (statZscore) statZscore.textContent = results.zScore.toFixed(2);
                    let zScoreText = this.interpretZScore(results.zScore);
                    if (results.isPrediction) {
                        zScoreText += ' (predicted)';
                    }
                    const statZscoreComp = getElement('stat-zscore-comp');
                    if (statZscoreComp) statZscoreComp.textContent = zScoreText;
                }

                // Update details
                this.updateDetails(results, isFutureDate, matchType, weekData);
                this.updateHistoricalContext(results, isFutureDate, matchType, weekData);
                this.updatePercentileInfo(results.percentile, results.zScore, results.isPrediction);
            }

            formatDate(date) {
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            }

            formatCurrency(value) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            }

            interpretZScore(zScore) {
                if (Math.abs(zScore) < 0.5) return 'Within normal range';
                if (Math.abs(zScore) < 1.0) return 'Moderately different';
                if (Math.abs(zScore) < 1.5) return 'Significantly different';
                if (Math.abs(zScore) < 2.0) return 'Highly unusual';
                return 'Extremely unusual';
            }

            getBusinessZScoreInterpretation(zScore) {
                if (Math.abs(zScore) < 0.5) return 'Normal week';
                if (Math.abs(zScore) < 1.0) return 'Slightly unusual';
                if (Math.abs(zScore) < 1.5) return 'Notable difference';
                if (Math.abs(zScore) < 2.0) return 'Unusual week';
                return 'Very unusual week';
            }

            getBusinessRating(rating) {
                const ratingMap = {
                    'Exceptionally Busy': 'Very Busy',
                    'Busy': 'Busy',
                    'Average': 'Average',
                    'Slow': 'Slow',
                    'Very Slow': 'Very Slow'
                };
                return ratingMap[rating] || rating;
            }

            updateStatLabels() {
                const salesLabel = document.getElementById('stat-label-sales');
                const diffLabel = document.getElementById('stat-label-diff');
                const ratingLabel = document.getElementById('stat-label-rating');
                const zscoreLabel = document.getElementById('stat-label-zscore');
                const zscoreCard = document.getElementById('stat-card-zscore');
                const historicalTitle = document.getElementById('historical-context-title');
                const percentileTitle = document.getElementById('percentile-title');

                if (this.isBusinessMode) {
                    if (salesLabel) salesLabel.textContent = 'Week Sales';
                    if (diffLabel) diffLabel.textContent = 'Difference from Average';
                    if (ratingLabel) ratingLabel.textContent = 'Performance Level';
                    // Hide Z-Score card in business view
                    if (zscoreCard) zscoreCard.style.display = 'none';
                    if (historicalTitle) historicalTitle.textContent = 'What to Expect';
                    if (percentileTitle) percentileTitle.textContent = 'How This Week Compares';
                } else {
                    if (salesLabel) salesLabel.textContent = 'Weekly Revenue';
                    if (diffLabel) diffLabel.textContent = 'Deviation from Mean';
                    if (ratingLabel) ratingLabel.textContent = 'Performance Rating';
                    if (zscoreLabel) zscoreLabel.textContent = 'Z-Score';
                    // Show Z-Score card in scientific view
                    if (zscoreCard) zscoreCard.style.display = 'block';
                    if (historicalTitle) historicalTitle.textContent = 'Historical Context';
                    if (percentileTitle) percentileTitle.textContent = 'Percentile Ranking';
                }
            }

            updateDetails(results, isFutureDate, matchType, weekData) {
                const businessContent = document.getElementById('detail-content-business');
                const scientificContent = document.getElementById('detail-content-scientific');
                const businessTitle = document.getElementById('detail-title-business');
                const scientificTitle = document.getElementById('detail-title-scientific');

                if (!businessContent || !scientificContent || !businessTitle || !scientificTitle) {
                    console.error('One or more detail elements not found');
                    return;
                }

                if (this.isBusinessMode) {
                    businessContent.style.display = 'block';
                    scientificContent.style.display = 'none';
                    businessTitle.style.display = 'block';
                    scientificTitle.style.display = 'none';

                    let predictionNote = '';
                    if (results.isPrediction) {
                        if (results.basedOnWeeks && results.basedOnWeeks.length > 1) {
                            predictionNote = `<p><strong> Prediction Method:</strong> This prediction is based on the average of ${results.basedOnWeeks.length} similar weeks from previous years (same time of year). This gives you a better sense of what to expect based on seasonal patterns.</p>`;
                        } else if (results.basedOnWeeks && results.basedOnWeeks.length === 1) {
                            predictionNote = `<p><strong> Prediction Method:</strong> This prediction is based on the closest historical week in your data. Use this as a baseline expectation for planning.</p>`;
                        } else {
                            predictionNote = `<p><strong> Prediction Method:</strong> This prediction is based on historical data patterns. Use this to anticipate whether it will be a busy or slow week.</p>`;
                        }
                    }

                    const verb = results.isPrediction ? 'is expected to have' : 'had';
                    const tense = results.isPrediction ? 'will be' : 'was';

                    businessContent.innerHTML = `
                        ${predictionNote}
                        <p><strong>Performance ${results.isPrediction ? 'Prediction' : 'Summary'}:</strong> This week ${verb} sales of ${this.formatCurrency(results.weekValue)}, which ${results.isPrediction ? 'would be' : 'is'} ${Math.abs(results.comparison.percentDiff).toFixed(1)}% ${results.comparison.percentDiff >= 0 ? 'above' : 'below'} your restaurant's overall average of ${this.formatCurrency(this.statistics.mean)}.</p>
                        <p><strong>What This Means:</strong> This ${tense} expected to be a ${results.rating.toLowerCase()} week for your restaurant. ${results.comparison.percentDiff >= 0 ? 'You can expect better than usual performance, which is great news!' : 'This may be slower than your typical performance, so plan accordingly.'}</p>
                        <p><strong>Context:</strong> Your average weekly sales across all ${this.statistics.total_weeks} weeks is ${this.formatCurrency(this.statistics.mean)}, so this week ${results.isPrediction ? 'is expected to be' : 'was'} ${results.comparison.valueDiff >= 0 ? 'above' : 'below'} average by ${this.formatCurrency(Math.abs(results.comparison.valueDiff))}.</p>
                    `;
                } else {
                    businessContent.style.display = 'none';
                    scientificContent.style.display = 'block';
                    businessTitle.style.display = 'none';
                    scientificTitle.style.display = 'block';

                    let predictionNote = '';
                    if (results.isPrediction) {
                        if (results.basedOnWeeks && results.basedOnWeeks.length > 1) {
                            predictionNote = `<p><strong>Prediction Methodology:</strong> Estimated value derived from averaging ${results.basedOnWeeks.length} historical observations from the same week-of-year across previous years. This accounts for seasonal variation in the time series.</p>`;
                        } else {
                            predictionNote = `<p><strong>Prediction Methodology:</strong> Estimated value based on nearest historical observation. This provides a baseline expectation but does not account for seasonal patterns.</p>`;
                        }
                    }

                    const verb = results.isPrediction ? 'is predicted to show' : 'shows';

                    scientificContent.innerHTML = `
                        ${predictionNote}
                        <p><strong>Statistical Analysis:</strong> The selected week ${verb} weekly sales of ${this.formatCurrency(results.weekValue)} ( = ${this.formatCurrency(this.statistics.mean)},  = ${this.formatCurrency(this.statistics.sd)}).</p>
                        <p><strong>Z-Score Interpretation:</strong> The week has a z-score of ${results.zScore.toFixed(2)}, indicating it ${results.isPrediction ? 'would be' : 'is'} ${Math.abs(results.zScore).toFixed(2)} standard deviations ${results.zScore >= 0 ? 'above' : 'below'} the population mean. This places it at the ${results.percentile.toFixed(1)}th percentile of the distribution.</p>
                        <p><strong>Effect Size:</strong> The difference of ${this.formatCurrency(Math.abs(results.comparison.valueDiff))} represents a ${Math.abs(results.comparison.percentDiff).toFixed(1)}% deviation from the mean, which is ${Math.abs(results.zScore) < 1 ? 'not statistically significant' : Math.abs(results.zScore) < 2 ? 'moderately significant' : 'highly significant'}.</p>
                    `;
                }
            }

            updateHistoricalContext(results, isFutureDate, matchType, weekData) {
                const container = document.getElementById('historical-context');
                if (!container) {
                    console.error('Element with id "historical-context" not found');
                    return;
                }

                let contextHTML = '';

                if (results.isPrediction && results.basedOnWeeks && results.basedOnWeeks.length > 0) {
                    if (this.isBusinessMode) {
                        contextHTML += `<p><strong>Based on Similar Weeks:</strong> This prediction uses ${results.basedOnWeeks.length} similar week${results.basedOnWeeks.length !== 1 ? 's' : ''} from past years around the same time:</p><ul>`;
                        results.basedOnWeeks.slice(0, 5).forEach(week => {
                            contextHTML += `<li>${this.formatDate(week.date)}: ${this.formatCurrency(week.value)}</li>`;
                        });
                        if (results.basedOnWeeks.length > 5) {
                            contextHTML += `<li><em>... and ${results.basedOnWeeks.length - 5} more similar weeks</em></li>`;
                        }
                        contextHTML += '</ul>';
                        if (results.basedOnWeeks.length > 1) {
                            const avgValue = results.basedOnWeeks.reduce((sum, w) => sum + w.value, 0) / results.basedOnWeeks.length;
                            contextHTML += `<p><strong>Average of these weeks:</strong> ${this.formatCurrency(avgValue)} - This is what we expect for your selected week.</p>`;
                        }
                    } else {
                        contextHTML += `<p><strong>Historical Observations:</strong> ${results.basedOnWeeks.length} observation${results.basedOnWeeks.length !== 1 ? 's' : ''} used for prediction:</p><ul>`;
                        results.basedOnWeeks.slice(0, 5).forEach(week => {
                            const weekDiff = ((week.value - results.weekValue) / results.weekValue) * 100;
                            contextHTML += `<li>${this.formatDate(week.date)} - ${this.formatCurrency(week.value)} (${weekDiff >= 0 ? '+' : ''}${weekDiff.toFixed(1)}% deviation from predicted value)</li>`;
                        });
                        if (results.basedOnWeeks.length > 5) {
                            contextHTML += `<li><em>... and ${results.basedOnWeeks.length - 5} additional observations</em></li>`;
                        }
                        contextHTML += '</ul>';
                        if (results.basedOnWeeks.length > 1) {
                            const avgValue = results.basedOnWeeks.reduce((sum, w) => sum + w.value, 0) / results.basedOnWeeks.length;
                            contextHTML += `<p><strong>Mean of historical observations:</strong> ${this.formatCurrency(avgValue)} (used as prediction estimate)</p>`;
                        }
                    }
                } else if (results.previousWeek || results.nextWeek) {
                    if (results.previousWeek) {
                        const prevDiff = ((results.weekValue - results.previousWeek.value) / results.previousWeek.value) * 100;
                        if (this.isBusinessMode) {
                            contextHTML += `<p><strong>Previous Week:</strong> ${this.formatDate(results.previousWeek.date)} had sales of ${this.formatCurrency(results.previousWeek.value)}, which is ${Math.abs(prevDiff).toFixed(1)}% ${prevDiff >= 0 ? 'less' : 'more'} than this week.</p>`;
                        } else {
                            contextHTML += `<p><strong>Previous Week:</strong> ${this.formatDate(results.previousWeek.date)} - ${this.formatCurrency(results.previousWeek.value)} (${prevDiff >= 0 ? '+' : ''}${prevDiff.toFixed(1)}% change)</p>`;
                        }
                    }

                    if (results.nextWeek) {
                        const nextDiff = ((results.nextWeek.value - results.weekValue) / results.weekValue) * 100;
                        if (this.isBusinessMode) {
                            contextHTML += `<p><strong>Next Week:</strong> ${this.formatDate(results.nextWeek.date)} had sales of ${this.formatCurrency(results.nextWeek.value)}, which is ${Math.abs(nextDiff).toFixed(1)}% ${nextDiff >= 0 ? 'more' : 'less'} than this week.</p>`;
                        } else {
                            contextHTML += `<p><strong>Next Week:</strong> ${this.formatDate(results.nextWeek.date)} - ${this.formatCurrency(results.nextWeek.value)} (${nextDiff >= 0 ? '+' : ''}${nextDiff.toFixed(1)}% change)</p>`;
                        }
                    }
                }

                if (results.similarWeeks && results.similarWeeks.length > 0) {
                    if (this.isBusinessMode) {
                        contextHTML += `<p><strong>Similar Weeks:</strong> We found ${results.similarWeeks.length} other week${results.similarWeeks.length !== 1 ? 's' : ''} with similar sales (within 5%):</p><ul>`;
                        results.similarWeeks.slice(0, 5).forEach(week => {
                            contextHTML += `<li>${this.formatDate(week.date)}: ${this.formatCurrency(week.value)}</li>`;
                        });
                        contextHTML += '</ul>';
                    } else {
                        contextHTML += `<p><strong>Similar Historical Weeks:</strong> Found ${results.similarWeeks.length} week${results.similarWeeks.length !== 1 ? 's' : ''} with similar performance (within 5%):</p><ul>`;
                        results.similarWeeks.slice(0, 5).forEach(week => {
                            contextHTML += `<li>${this.formatDate(week.date)} - ${this.formatCurrency(week.value)}</li>`;
                        });
                        contextHTML += '</ul>';
                    }
                }

                container.innerHTML = contextHTML || (this.isBusinessMode ? '<p>No additional context available for this week.</p>' : '<p>No additional context available.</p>');
            }

            updatePercentileInfo(percentile, zScore, isPrediction) {
                const container = document.getElementById('percentile-info');
                if (!container) {
                    console.error('Element with id "percentile-info" not found');
                    return;
                }

                const verb = isPrediction ? 'is expected to perform' : 'performed';
                const tense = isPrediction ? 'will be' : 'was';

                const percentileText = this.isBusinessMode
                    ? `<p>Your selected period ${verb} better than <strong>${percentile.toFixed(1)}%</strong> of all weeks in your data. This means it ${tense} ${percentile > 50 ? 'busier' : 'slower'} than most of your typical weeks.</p>`
                    : `<p>The period mean ${isPrediction ? 'is predicted to fall' : 'falls'} at the <strong>${percentile.toFixed(1)}th percentile</strong> of the empirical distribution. With a z-score of ${zScore.toFixed(2)}, this represents ${zScore >= 0 ? 'above-average' : 'below-average'} performance relative to the historical mean.</p>`;

                const note = isPrediction
                    ? `<p><small>Expected percentile ranking based on ${this.salesData.length} weeks of historical data</small></p>`
                    : `<p><small>Percentile ranking based on ${this.salesData.length} weeks of historical data</small></p>`;

                container.innerHTML = `
                    ${percentileText}
                    <div class="percentile-bar">
                        <div class="percentile-fill" style="width: ${percentile}%"></div>
                    </div>
                    ${note}
                `;
            }

            updateLanguageMode() {
                if (window.languageToggle) {
                    this.isBusinessMode = window.languageToggle.isBusinessMode;
                }

                // Update stat labels (including showing/hiding Z-Score card)
                this.updateStatLabels();

                // Update section description
                const description = document.getElementById('analyzer-description');
                if (description) {
                    description.textContent = this.isBusinessMode
                        ? "Select any date to see if that week was busy or slow compared to your restaurant's average performance."
                        : "Select a date to analyze weekly performance metrics relative to the historical distribution and statistical parameters.";
                }

                // Re-display last results if they exist
                if (this.lastResults && this.lastSelectedDate) {
                    this.displayResults(
                        this.lastResults,
                        this.lastSelectedDate,
                        this.lastIsFutureDate,
                        this.lastMatchType,
                        this.lastWeekData
                    );
                }
            }
        }

        // Initialize the dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new DashboardApp();
            new ReportManager();
            window.languageToggle = new LanguageToggle();
            window.weekAnalyzer = new WeekAnalyzer();

            // Initialize dynamic metrics dashboard
            setTimeout(() => {
                try {
                    window.dynamicDashboard = new DynamicMetricsDashboard();
                } catch (error) {
                    console.error('Failed to initialize dynamic dashboard:', error);
                }
            }, 100);


            // Test report file accessibility
            testReportFiles();

            // Add loading states for images
            document.querySelectorAll('img').forEach(img => {
                img.addEventListener('load', () => {
                    img.style.opacity = '1';
                });

                img.addEventListener('error', () => {
                    img.style.opacity = '0.5';
                    img.style.filter = 'grayscale(100%)';
                });
            });
        });

        // Test function to check if report files are accessible
        async function testReportFiles() {
            const reportFiles = [
                'TIME_SERIES_DECOMPOSITION_ANALYSIS.md',
                'TREND_DECOMPOSITION_BUSINESS_ANALYSIS.md',
                'DETRENDED_SALES_HEATMAP_ANALYSIS.md',
                'MONTHLY_SALES_PATTERNS_ANALYSIS.md',
                'BUSINESS_INTELLIGENCE_SUMMARY_ANALYSIS.md',
                'BUSINESS_PLANNING_GUIDE.md'
            ];

            console.log('Testing report files...');

            for (const file of reportFiles) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    console.log(`${file}: ${response.ok ? 'OK' : 'NOT FOUND'}`);
                } catch (error) {
                    console.log(`${file}: ERROR`);
                }
            }
        }

        // Report Manager Class
        class ReportManager {
            constructor() {
                this.currentReport = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Preview buttons
                document.querySelectorAll('.preview-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const reportFile = e.target.closest('.preview-btn').getAttribute('data-report');
                        this.previewReport(reportFile);
                    });
                });

                // Modal close buttons
                document.getElementById('closeReportModal').addEventListener('click', () => {
                    this.closeReportModal();
                });

                document.getElementById('closeReportBtn').addEventListener('click', () => {
                    this.closeReportModal();
                });

                // Download from preview
                document.getElementById('downloadFromPreview').addEventListener('click', () => {
                    if (this.currentReport) {
                        // Create a direct download link
                        const link = document.createElement('a');
                        link.href = this.currentReport.file;
                        link.download = this.currentReport.filename;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showNotification('Download initiated!', 'success');
                    }
                });

                // Close modal when clicking outside
                document.getElementById('reportModal').addEventListener('click', (e) => {
                    if (e.target.id === 'reportModal') {
                        this.closeReportModal();
                    }
                });
            }

            async previewReport(reportFile) {
                const modal = document.getElementById('reportModal');
                const content = document.getElementById('reportContent');
                const title = document.getElementById('reportTitle');

                console.log('Loading report:', reportFile);

                // Show modal with loading
                modal.style.display = 'block';
                content.innerHTML = '<div class="loading">Loading report...</div>';

                try {
                    // Try multiple approaches to load the file
                    let markdown = null;
                    let error = null;

                    // Method 1: Direct fetch
                    try {
                        const response = await fetch(reportFile);
                        if (response.ok) {
                            markdown = await response.text();
                            console.log('Method 1 (fetch) successful, content length:', markdown.length);
                        }
                    } catch (e) {
                        console.log('Method 1 failed:', e.message);
                        error = e;
                    }

                    // Method 2: If fetch failed, try with XMLHttpRequest
                    if (!markdown) {
                        try {
                            markdown = await this.loadFileWithXHR(reportFile);
                            console.log('Method 2 (XHR) successful, content length:', markdown.length);
                        } catch (e) {
                            console.log('Method 2 failed:', e.message);
                            error = e;
                        }
                    }

                    // Method 3: If both failed, show embedded content
                    if (!markdown) {
                        markdown = this.getEmbeddedContent(reportFile);
                        if (markdown) {
                            console.log('Method 3 (embedded) successful, content length:', markdown.length);
                        } else {
                            throw new Error('Unable to load file content');
                        }
                    }

                    if (!markdown || markdown.trim().length === 0) {
                        throw new Error('Empty content received');
                    }

                    // Update modal content
                    title.textContent = this.getReportTitle(reportFile);

                    // Simple markdown to HTML conversion
                    const html = this.simpleMarkdownToHtml(markdown);
                    content.innerHTML = html;

                    // Store current report info
                    this.currentReport = {
                        file: reportFile,
                        filename: this.getReportFilename(reportFile)
                    };

                    // Add show class for animation
                    setTimeout(() => {
                        modal.classList.add('show');
                    }, 10);

                } catch (error) {
                    console.error('Error loading report:', error);
                    content.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <h3>Preview Not Available</h3>
                            <p>Unable to load preview for: <strong>${reportFile}</strong></p>
                            <p>Error: ${error.message}</p>
                            <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                                Try opening the file directly in your browser or text editor.
                            </p>
                        </div>
                    `;
                }
            }

            loadFileWithXHR(filePath) {
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', filePath, true);
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                resolve(xhr.responseText);
                            } else {
                                reject(new Error(`XHR failed: ${xhr.status}`));
                            }
                        }
                    };
                    xhr.onerror = () => reject(new Error('XHR network error'));
                    xhr.send();
                });
            }

            getEmbeddedContent(filePath) {
                // Check if we're in business mode
                const isBusinessMode = window.languageToggle ? window.languageToggle.isBusinessMode : false;

                // Return sample content for common files
                const contentMap = {
                    'TIME_SERIES_DECOMPOSITION_ANALYSIS.md': isBusinessMode ? this.getBusinessFriendlyTimeSeriesContent() : this.getTimeSeriesContent(),
                    'TREND_DECOMPOSITION_BUSINESS_ANALYSIS.md': isBusinessMode ? this.getBusinessFriendlyTrendAnalysisContent() : this.getTrendAnalysisContent(),
                    'DETRENDED_SALES_HEATMAP_ANALYSIS.md': isBusinessMode ? this.getBusinessFriendlyHeatmapContent() : this.getHeatmapContent(),
                    'MONTHLY_SALES_PATTERNS_ANALYSIS.md': isBusinessMode ? this.getBusinessFriendlyMonthlyPatternsContent() : this.getMonthlyPatternsContent(),
                    'BUSINESS_INTELLIGENCE_SUMMARY_ANALYSIS.md': isBusinessMode ? this.getBusinessFriendlyBusinessIntelligenceContent() : this.getBusinessIntelligenceContent(),
                    'BUSINESS_PLANNING_GUIDE.md': isBusinessMode ? this.getBusinessFriendlyBusinessPlanningContent() : this.getBusinessPlanningContent()
                };

                return contentMap[filePath] || null;
            }

            getTimeSeriesContent() {
                return `# Core Time Series Analysis

## Overview
This analysis examines the restaurant's sales data from July 2023 to July 2025, revealing key patterns and trends that drive business performance.

## Key Findings

### Growth Trend
- **Weekly Growth Rate**: $177.86 per week
- **Annual Growth**: $9,200+ annually
- **Total Growth Period**: $17,000 increase over 2 years

### Seasonal Patterns
- **Primary Peak**: October/November (+$8K-$10K above trend)
- **Secondary Peak**: April/May (+$6K-$8K above trend)
- **Primary Trough**: January/February (-$8K-$10K below trend)
- **Secondary Trough**: July/August (-$6K-$8K below trend)

### Statistical Components
- **Trend Component**: 85% contribution to sales variation
- **Seasonal Component**: 15% contribution
- **Residual Component**: <5% contribution

## Business Implications

### Strategic Planning
- **Peak Preparation**: 3-week advance notice required
- **Resource Allocation**: 25-30% staffing increase during peaks
- **Inventory Management**: 20-25% stock increase during peak seasons

### Forecasting Accuracy
- **Short-term (3-6 months)**: High accuracy with $3,000 confidence
- **Long-term (1-2 years)**: Moderate accuracy with $8,000 confidence

## Recommendations
1. Implement seasonal staffing adjustments
2. Develop peak-period marketing campaigns
3. Optimize inventory for seasonal demand
4. Plan expansion during growth periods`;
            }

            getTrendAnalysisContent() {
                return `# Advanced Decomposition Analysis

## Statistical Decomposition Results

### Trend Analysis
The linear growth trend shows consistent upward movement:
- **Starting Point**: $40,000/week (July 2023)
- **Ending Point**: $57,000/week (July 2025)
- **Growth Rate**: $177.86/week

### Seasonal Decomposition
- **Pattern Type**: Bimodal seasonal pattern
- **Peak Seasons**: Spring (April/May) and Fall (October/November)
- **Trough Seasons**: Winter (January/February) and Summer (July/August)

### Model Quality
- **R Value**: >0.95 (Excellent fit)
- **Residual Normality**: Acceptable
- **Forecast Reliability**: High for short-term predictions

## Component Breakdown

### Trend Component (85%)
- Linear growth pattern
- Consistent weekly increase
- Sustainable business trajectory

### Seasonal Component (15%)
- Predictable seasonal variations
- Consistent timing across years
- Manageable amplitude

### Residual Component (<5%)
- Low random fluctuations
- Minimal unpredictable variation
- Good model stability`;
            }

            getHeatmapContent() {
                return `# Detrended Sales Heatmap Analysis

## Heatmap Interpretation

### Color Intensity Scale
- **Dark Blue**: High seasonal intensity (peaks)
- **Light Blue**: Low seasonal intensity (troughs)
- **Medium Blue**: Moderate seasonal patterns

### Peak Periods
- **October-November**: Darkest blue intensity
- **April-May**: Medium-dark blue intensity
- **Peak Duration**: 6-8 weeks per peak

### Trough Periods
- **January-February**: Lightest blue intensity
- **July-August**: Light-medium blue intensity
- **Trough Duration**: 6-8 weeks per trough

## Pattern Consistency

### Cross-Year Stability
- **2023-2025**: Consistent pattern timing
- **Peak Reliability**: High predictability
- **Trough Consistency**: Regular occurrence

### Strategic Advantages
- **8-12 Week Notice**: Advance planning capability
- **Resource Optimization**: Precise staffing adjustments
- **Marketing Timing**: Strategic campaign planning

## Operational Insights

### Peak Management
- **Staffing**: +30% during peak periods
- **Inventory**: +25% stock levels
- **Preparation**: 3-week advance notice

### Trough Management
- **Cost Control**: -20% staffing needs
- **Efficiency**: Optimize operations
- **Maintenance**: Schedule during slow periods`;
            }

            getMonthlyPatternsContent() {
                return `# Monthly Sales Patterns Analysis

## Original vs Detrended Comparison

### Original Sales (Blue Bars)
- **2023 Range**: $38K-$44K monthly
- **2024 Range**: $40K-$57K monthly
- **2025 Range**: $50K+ monthly
- **Growth Pattern**: Strong upward trend

### Detrended Sales (Red Bars)
- **Seasonal Peaks**: Minimal red bars (strong performance)
- **Seasonal Troughs**: Large red bars (below trend)
- **Pattern Consistency**: Stable across years

## Monthly Breakdown

### Peak Months
- **October**: Strongest seasonal performance
- **November**: High seasonal demand
- **April**: Spring peak period
- **May**: Continued spring strength

### Trough Months
- **January**: Largest seasonal decline
- **February**: Continued winter weakness
- **July**: Summer seasonal low
- **August**: Extended summer trough

## Business Intelligence

### Performance Evaluation
- **Unbiased Assessment**: Removes growth bias
- **True Seasonal Effects**: Pure seasonal patterns
- **Comparable Metrics**: Year-over-year consistency

### Strategic Planning
- **Peak Preparation**: 3-month advance planning
- **Trough Management**: Cost optimization opportunities
- **Growth Attribution**: Clear performance drivers`;
            }

            getBusinessIntelligenceContent() {
                return `# Business Intelligence Summary

## Key Performance Metrics

### Growth Indicators
- **Weekly Growth**: $177.86
- **Annual Growth**: $9,200+
- **Growth Trajectory**: Sustainable upward trend

### Seasonal Strength
- **Seasonal Patterns**: 66.5% of sales variation
- **Peak Weeks**: 11 weeks per year
- **Forecast Horizon**: 12 weeks reliable prediction

### Operational Metrics
- **Average Weekly Sales**: $48,673
- **Volatility**: 16.3% (manageable)
- **Pattern Reliability**: High consistency

## Strategic Insights

### Investment Confidence
- **Growth Significance**: Statistically significant
- **Expansion Justification**: Strong growth supports investment
- **Risk Assessment**: Low volatility indicates stability

### Operational Optimization
- **Peak Management**: 25-30% staffing increase needed
- **Seasonal Marketing**: 66.5% effectiveness potential
- **Resource Planning**: 11 peak weeks require preparation

### Financial Planning
- **Cash Flow**: Stable weekly revenue
- **Seasonal Variations**: Predictable patterns
- **Growth Projection**: Continued upward trajectory

## Action Items

### Immediate Actions
1. **Peak Preparation**: Plan for 11 peak weeks
2. **Seasonal Campaigns**: Align with 66.5% seasonal strength
3. **Staff Scheduling**: Use 12-week forecast horizon

### Long-term Strategy
1. **Capacity Planning**: Prepare for continued growth
2. **Seasonal Expansion**: Consider peak-period opportunities
3. **Technology Investment**: Systems for seasonal management`;
            }

            getBusinessPlanningContent() {
                return `# Business Planning Guide

## Strategic Planning Framework

### Growth Strategy
- **Current Trajectory**: $177.86 weekly growth
- **Projected 2025**: $65K-$70K weekly sales
- **Expansion Opportunities**: Peak period optimization

### Seasonal Planning
- **Peak Periods**: October/November, April/May
- **Trough Periods**: January/February, July/August
- **Transition Planning**: 2-3 week adjustment periods

## Operational Guidelines

### Peak Season Management
- **Staffing**: +30% increase with 3-week notice
- **Inventory**: +25% stock levels
- **Marketing**: Pre-peak campaigns (September, March)

### Trough Season Management
- **Cost Control**: -20% staffing adjustments
- **Maintenance**: Schedule during slow periods
- **Training**: Staff development opportunities

### Year-Round Optimization
- **Forecasting**: 12-week reliable predictions
- **Resource Allocation**: Seasonal demand alignment
- **Performance Monitoring**: Regular pattern analysis

## Implementation Timeline

### Short-term (1-3 months)
1. Implement seasonal staffing adjustments
2. Develop peak-period marketing campaigns
3. Optimize inventory management

### Medium-term (3-12 months)
1. Expand capacity for growth
2. Develop seasonal menu offerings
3. Implement forecasting systems

### Long-term (1-2 years)
1. Consider expansion opportunities
2. Develop seasonal business models
3. Optimize technology systems`;
            }

            // Business-friendly content methods
            getBusinessFriendlyTimeSeriesContent() {
                return `# Your Restaurant's Growth Story

## The Bottom Line

Your restaurant is doing great! You're growing steadily and have predictable busy and slow seasons. Here's what you need to know to make smart business decisions.

## Your Growth Story

### The Good News
- **You're Growing:** Your sales are increasing by about $178 every week
- **That's Real Money:** Over a year, that's about $9,200 more in sales
- **It's Consistent:** This growth has been steady for over 2 years
- **It's Reliable:** The numbers show this isn't just luck - it's real business growth

### What This Means
- You can confidently plan for continued growth
- It's safe to invest in your business
- You can hire more staff and expand your menu
- Your business model is working well

##  Your Busy and Slow Seasons

### When You're Busiest (Plan Ahead!)
- **October & November:** Your biggest rush of the year
- **April & May:** Your second busiest time
- **What to Do:** Start preparing 3 weeks before these periods

### When You're Slowest (Save Money!)
- **January & February:** Your quietest months
- **July & August:** Your second quietest time
- **What to Do:** Use these times for maintenance, training, and planning

### The Pattern is Predictable
- You have 11 peak weeks each year
- You can see these patterns coming 8-12 weeks ahead
- This gives you time to prepare properly

## Smart Business Moves

### Staffing Strategy
- **During Busy Times:** Add 25-30% more staff
- **During Slow Times:** Reduce staff by about 20%
- **Plan Ahead:** Start hiring 3 weeks before busy seasons

### Inventory Management
- **Stock Up:** Increase inventory by 20-25% before busy seasons
- **Save Money:** Reduce inventory during slow periods
- **Don't Run Out:** Plan your ordering carefully

### Marketing Strategy
- **Timing is Everything:** Run marketing campaigns 2-3 weeks before busy seasons
- **Target Your Efforts:** Focus on the periods when people are most likely to visit
- **Use Your Data:** Your busy seasons are when marketing works best

## Your Competitive Advantages

### You Can Predict the Future
- You can forecast sales 12 weeks ahead with good accuracy
- This gives you a huge advantage over competitors who can't plan ahead
- You can make smart decisions about staffing, inventory, and marketing

### Your Growth is Sustainable
- Your growth isn't just a temporary spike
- It's based on solid business fundamentals
- You can confidently invest in expansion

### You Understand Your Customers
- You know when your customers want to visit
- You can prepare for their needs
- You can optimize your operations for maximum efficiency

## Action Plan

### Immediate Actions (Next 30 Days)
1. **Review Your Calendar:** Mark your 11 peak weeks for the coming year
2. **Plan Your Staffing:** Start thinking about hiring for busy seasons
3. **Review Your Menu:** Consider seasonal specials for peak periods
4. **Plan Your Marketing:** Schedule campaigns for pre-peak periods

### Short-term Goals (Next 3 Months)
1. **Optimize Your Operations:** Use your slow periods for improvements
2. **Train Your Team:** Use quiet times for training and development
3. **Plan Your Inventory:** Create a seasonal inventory plan
4. **Review Your Pricing:** Consider seasonal pricing strategies

### Long-term Strategy (Next Year)
1. **Consider Expansion:** Your growth supports expansion plans
2. **Invest in Technology:** Systems to help manage seasonal variations
3. **Develop Seasonal Offerings:** Special menus for peak periods
4. **Build Your Team:** Hire and train staff for growth

## Financial Planning

### Cash Flow Management
- **Peak Seasons:** Expect 25-30% more revenue
- **Slow Seasons:** Plan for 20% less revenue
- **Overall Growth:** Expect continued steady growth

### Investment Opportunities
- **Staffing:** Safe to invest in additional staff
- **Equipment:** Consider upgrades during slow periods
- **Marketing:** Increase marketing budget before peak seasons
- **Expansion:** Your growth supports expansion plans

## The Bottom Line

Your restaurant is in an excellent position:
- **Growing steadily** with predictable patterns
- **Manageable risks** with low volatility
- **Clear opportunities** for optimization and expansion
- **Competitive advantages** through data-driven planning

You have the data and insights to make confident business decisions. Use this information to optimize your operations, plan for growth, and maximize your profits!`;
            }

            getBusinessFriendlyTrendAnalysisContent() {
                return `# Understanding Your Sales Patterns

## What This Tells You

Your restaurant has very predictable busy and slow seasons. This is actually great news because you can plan ahead and make smart business decisions!

##  Your Yearly Pattern

### The Busy Seasons (Make Money!)
- **October & November:** Your biggest money-makers
- **April & May:** Your second busiest time
- **What Happens:** Sales jump up by $8,000-$10,000 above normal
- **Why This Matters:** These are your profit-making periods

### The Slow Seasons (Save Money!)
- **January & February:** Your quietest months
- **July & August:** Your second quietest time
- **What Happens:** Sales drop by $6,000-$8,000 below normal
- **Why This Matters:** These are your cost-cutting opportunities

## Smart Planning Strategies

### Before Busy Seasons (Start 3 Weeks Early)
1. **Hire Extra Staff:** You'll need 25-30% more people
2. **Stock Up on Food:** Increase inventory by 20-25%
3. **Plan Your Marketing:** Run campaigns to attract customers
4. **Prepare Your Team:** Train staff for the rush

### During Slow Seasons (Optimize Operations)
1. **Reduce Staffing:** Cut back by about 20%
2. **Do Maintenance:** Fix equipment and update systems
3. **Train Your Team:** Use quiet time for development
4. **Plan for the Future:** Work on new menus and strategies

## The Numbers That Matter

### Your Peak Weeks
- **11 weeks per year** when you're busiest
- **That's about 2-3 weeks each season**
- **You can predict these 8-12 weeks ahead**

### Your Planning Window
- **Short-term:** 3-6 months ahead (very accurate)
- **Medium-term:** 6-12 months ahead (good accuracy)
- **Long-term:** 1+ years ahead (general trends)

## Business Benefits

### You Can Outsmart Your Competition
- Most restaurants don't know their patterns this well
- You can prepare while they're scrambling
- You can optimize your operations for maximum profit

### You Can Make Better Decisions
- **Hiring:** Know exactly when you need more staff
- **Inventory:** Order the right amounts at the right times
- **Marketing:** Spend money when it will have the biggest impact
- **Pricing:** Consider seasonal pricing strategies

### You Can Reduce Stress
- No more surprises when it gets busy
- No more panic when it gets slow
- You can plan your personal time around business patterns

## Action Items

### This Month
1. **Mark Your Calendar:** Highlight your 11 peak weeks for next year
2. **Review Your Staffing:** Plan who you'll need during busy times
3. **Check Your Inventory:** Plan what you'll need to stock up on
4. **Plan Your Marketing:** Schedule campaigns for pre-peak periods

### Next Quarter
1. **Optimize Your Menu:** Consider seasonal specials
2. **Train Your Team:** Prepare staff for busy seasons
3. **Review Your Suppliers:** Make sure they can handle your peak demands
4. **Plan Your Budget:** Allocate resources for seasonal variations

### Next Year
1. **Consider Expansion:** Your growth supports expansion plans
2. **Invest in Systems:** Technology to help manage seasonal changes
3. **Develop Seasonal Offerings:** Special menus for peak periods
4. **Build Your Team:** Hire and train for growth

## Financial Impact

### Peak Season Opportunities
- **Extra Revenue:** $8,000-$10,000 more per week during peaks
- **Higher Profits:** Better margins due to higher volume
- **Marketing ROI:** More effective during busy periods

### Slow Season Strategies
- **Cost Savings:** Reduce expenses by 20% during slow periods
- **Efficiency Gains:** Optimize operations when it's quiet
- **Investment Time:** Use slow periods for improvements

## The Bottom Line

Your seasonal patterns are a **competitive advantage**, not a problem. You have:
- **Predictable busy seasons** to maximize profits
- **Manageable slow seasons** to optimize operations
- **Clear planning windows** to make smart decisions
- **Data-driven insights** to outperform competitors

Use this knowledge to plan ahead, optimize your operations, and maximize your restaurant's success!`;
            }

            getBusinessFriendlyHeatmapContent() {
                return `# Your Busy and Slow Seasons

## What This Tells You

Your restaurant has very predictable busy and slow seasons. This is actually great news because you can plan ahead and make smart business decisions!

##  Your Yearly Pattern

### The Busy Seasons (Make Money!)
- **October & November:** Your biggest money-makers
- **April & May:** Your second busiest time
- **What Happens:** Sales jump up by $8,000-$10,000 above normal
- **Why This Matters:** These are your profit-making periods

### The Slow Seasons (Save Money!)
- **January & February:** Your quietest months
- **July & August:** Your second quietest time
- **What Happens:** Sales drop by $6,000-$8,000 below normal
- **Why This Matters:** These are your cost-cutting opportunities

## Smart Planning Strategies

### Before Busy Seasons (Start 3 Weeks Early)
1. **Hire Extra Staff:** You'll need 25-30% more people
2. **Stock Up on Food:** Increase inventory by 20-25%
3. **Plan Your Marketing:** Run campaigns to attract customers
4. **Prepare Your Team:** Train staff for the rush

### During Slow Seasons (Optimize Operations)
1. **Reduce Staffing:** Cut back by about 20%
2. **Do Maintenance:** Fix equipment and update systems
3. **Train Your Team:** Use quiet time for development
4. **Plan for the Future:** Work on new menus and strategies

## The Numbers That Matter

### Your Peak Weeks
- **11 weeks per year** when you're busiest
- **That's about 2-3 weeks each season**
- **You can predict these 8-12 weeks ahead**

### Your Planning Window
- **Short-term:** 3-6 months ahead (very accurate)
- **Medium-term:** 6-12 months ahead (good accuracy)
- **Long-term:** 1+ years ahead (general trends)

## Business Benefits

### You Can Outsmart Your Competition
- Most restaurants don't know their patterns this well
- You can prepare while they're scrambling
- You can optimize your operations for maximum profit

### You Can Make Better Decisions
- **Hiring:** Know exactly when you need more staff
- **Inventory:** Order the right amounts at the right times
- **Marketing:** Spend money when it will have the biggest impact
- **Pricing:** Consider seasonal pricing strategies

### You Can Reduce Stress
- No more surprises when it gets busy
- No more panic when it gets slow
- You can plan your personal time around business patterns

## Action Items

### This Month
1. **Mark Your Calendar:** Highlight your 11 peak weeks for next year
2. **Review Your Staffing:** Plan who you'll need during busy times
3. **Check Your Inventory:** Plan what you'll need to stock up on
4. **Plan Your Marketing:** Schedule campaigns for pre-peak periods

### Next Quarter
1. **Optimize Your Menu:** Consider seasonal specials
2. **Train Your Team:** Prepare staff for busy seasons
3. **Review Your Suppliers:** Make sure they can handle your peak demands
4. **Plan Your Budget:** Allocate resources for seasonal variations

### Next Year
1. **Consider Expansion:** Your growth supports expansion plans
2. **Invest in Systems:** Technology to help manage seasonal changes
3. **Develop Seasonal Offerings:** Special menus for peak periods
4. **Build Your Team:** Hire and train for growth

## Financial Impact

### Peak Season Opportunities
- **Extra Revenue:** $8,000-$10,000 more per week during peaks
- **Higher Profits:** Better margins due to higher volume
- **Marketing ROI:** More effective during busy periods

### Slow Season Strategies
- **Cost Savings:** Reduce expenses by 20% during slow periods
- **Efficiency Gains:** Optimize operations when it's quiet
- **Investment Time:** Use slow periods for improvements

## The Bottom Line

Your seasonal patterns are a **competitive advantage**, not a problem. You have:
- **Predictable busy seasons** to maximize profits
- **Manageable slow seasons** to optimize operations
- **Clear planning windows** to make smart decisions
- **Data-driven insights** to outperform competitors

Use this knowledge to plan ahead, optimize your operations, and maximize your restaurant's success!`;
            }

            getBusinessFriendlyMonthlyPatternsContent() {
                return `# Monthly Performance Guide

## What This Tells You

Your restaurant has very predictable busy and slow seasons. This is actually great news because you can plan ahead and make smart business decisions!

##  Your Yearly Pattern

### The Busy Seasons (Make Money!)
- **October & November:** Your biggest money-makers
- **April & May:** Your second busiest time
- **What Happens:** Sales jump up by $8,000-$10,000 above normal
- **Why This Matters:** These are your profit-making periods

### The Slow Seasons (Save Money!)
- **January & February:** Your quietest months
- **July & August:** Your second quietest time
- **What Happens:** Sales drop by $6,000-$8,000 below normal
- **Why This Matters:** These are your cost-cutting opportunities

## Smart Planning Strategies

### Before Busy Seasons (Start 3 Weeks Early)
1. **Hire Extra Staff:** You'll need 25-30% more people
2. **Stock Up on Food:** Increase inventory by 20-25%
3. **Plan Your Marketing:** Run campaigns to attract customers
4. **Prepare Your Team:** Train staff for the rush

### During Slow Seasons (Optimize Operations)
1. **Reduce Staffing:** Cut back by about 20%
2. **Do Maintenance:** Fix equipment and update systems
3. **Train Your Team:** Use quiet time for development
4. **Plan for the Future:** Work on new menus and strategies

## The Numbers That Matter

### Your Peak Weeks
- **11 weeks per year** when you're busiest
- **That's about 2-3 weeks each season**
- **You can predict these 8-12 weeks ahead**

### Your Planning Window
- **Short-term:** 3-6 months ahead (very accurate)
- **Medium-term:** 6-12 months ahead (good accuracy)
- **Long-term:** 1+ years ahead (general trends)

## Business Benefits

### You Can Outsmart Your Competition
- Most restaurants don't know their patterns this well
- You can prepare while they're scrambling
- You can optimize your operations for maximum profit

### You Can Make Better Decisions
- **Hiring:** Know exactly when you need more staff
- **Inventory:** Order the right amounts at the right times
- **Marketing:** Spend money when it will have the biggest impact
- **Pricing:** Consider seasonal pricing strategies

### You Can Reduce Stress
- No more surprises when it gets busy
- No more panic when it gets slow
- You can plan your personal time around business patterns

## Action Items

### This Month
1. **Mark Your Calendar:** Highlight your 11 peak weeks for next year
2. **Review Your Staffing:** Plan who you'll need during busy times
3. **Check Your Inventory:** Plan what you'll need to stock up on
4. **Plan Your Marketing:** Schedule campaigns for pre-peak periods

### Next Quarter
1. **Optimize Your Menu:** Consider seasonal specials
2. **Train Your Team:** Prepare staff for busy seasons
3. **Review Your Suppliers:** Make sure they can handle your peak demands
4. **Plan Your Budget:** Allocate resources for seasonal variations

### Next Year
1. **Consider Expansion:** Your growth supports expansion plans
2. **Invest in Systems:** Technology to help manage seasonal changes
3. **Develop Seasonal Offerings:** Special menus for peak periods
4. **Build Your Team:** Hire and train for growth

## Financial Impact

### Peak Season Opportunities
- **Extra Revenue:** $8,000-$10,000 more per week during peaks
- **Higher Profits:** Better margins due to higher volume
- **Marketing ROI:** More effective during busy periods

### Slow Season Strategies
- **Cost Savings:** Reduce expenses by 20% during slow periods
- **Efficiency Gains:** Optimize operations when it's quiet
- **Investment Time:** Use slow periods for improvements

## The Bottom Line

Your seasonal patterns are a **competitive advantage**, not a problem. You have:
- **Predictable busy seasons** to maximize profits
- **Manageable slow seasons** to optimize operations
- **Clear planning windows** to make smart decisions
- **Data-driven insights** to outperform competitors

Use this knowledge to plan ahead, optimize your operations, and maximize your restaurant's success!`;
            }

            getBusinessFriendlyBusinessIntelligenceContent() {
                return `# What This Means for Your Business

## The Bottom Line

Your restaurant is doing great! You're growing steadily and have predictable busy and slow seasons. Here's what you need to know to make smart business decisions.

## Your Growth Story

### The Good News
- **You're Growing:** Your sales are increasing by about $178 every week
- **That's Real Money:** Over a year, that's about $9,200 more in sales
- **It's Consistent:** This growth has been steady for over 2 years
- **It's Reliable:** The numbers show this isn't just luck - it's real business growth

### What This Means
- You can confidently plan for continued growth
- It's safe to invest in your business
- You can hire more staff and expand your menu
- Your business model is working well

##  Your Busy and Slow Seasons

### When You're Busiest (Plan Ahead!)
- **October & November:** Your biggest rush of the year
- **April & May:** Your second busiest time
- **What to Do:** Start preparing 3 weeks before these periods

### When You're Slowest (Save Money!)
- **January & February:** Your quietest months
- **July & August:** Your second quietest time
- **What to Do:** Use these times for maintenance, training, and planning

### The Pattern is Predictable
- You have 11 peak weeks each year
- You can see these patterns coming 8-12 weeks ahead
- This gives you time to prepare properly

## Smart Business Moves

### Staffing Strategy
- **During Busy Times:** Add 25-30% more staff
- **During Slow Times:** Reduce staff by about 20%
- **Plan Ahead:** Start hiring 3 weeks before busy seasons

### Inventory Management
- **Stock Up:** Increase inventory by 20-25% before busy seasons
- **Save Money:** Reduce inventory during slow periods
- **Don't Run Out:** Plan your ordering carefully

### Marketing Strategy
- **Timing is Everything:** Run marketing campaigns 2-3 weeks before busy seasons
- **Target Your Efforts:** Focus on the periods when people are most likely to visit
- **Use Your Data:** Your busy seasons are when marketing works best

## Your Competitive Advantages

### You Can Predict the Future
- You can forecast sales 12 weeks ahead with good accuracy
- This gives you a huge advantage over competitors who can't plan ahead
- You can make smart decisions about staffing, inventory, and marketing

### Your Growth is Sustainable
- Your growth isn't just a temporary spike
- It's based on solid business fundamentals
- You can confidently invest in expansion

### You Understand Your Customers
- You know when your customers want to visit
- You can prepare for their needs
- You can optimize your operations for maximum efficiency

## Action Plan

### Immediate Actions (Next 30 Days)
1. **Review Your Calendar:** Mark your 11 peak weeks for the coming year
2. **Plan Your Staffing:** Start thinking about hiring for busy seasons
3. **Review Your Menu:** Consider seasonal specials for peak periods
4. **Plan Your Marketing:** Schedule campaigns for pre-peak periods

### Short-term Goals (Next 3 Months)
1. **Optimize Your Operations:** Use your slow periods for improvements
2. **Train Your Team:** Use quiet times for training and development
3. **Plan Your Inventory:** Create a seasonal inventory plan
4. **Review Your Pricing:** Consider seasonal pricing strategies

### Long-term Strategy (Next Year)
1. **Consider Expansion:** Your growth supports expansion plans
2. **Invest in Technology:** Systems to help manage seasonal variations
3. **Develop Seasonal Offerings:** Special menus for peak periods
4. **Build Your Team:** Hire and train staff for growth

## Financial Planning

### Cash Flow Management
- **Peak Seasons:** Expect 25-30% more revenue
- **Slow Seasons:** Plan for 20% less revenue
- **Overall Growth:** Expect continued steady growth

### Investment Opportunities
- **Staffing:** Safe to invest in additional staff
- **Equipment:** Consider upgrades during slow periods
- **Marketing:** Increase marketing budget before peak seasons
- **Expansion:** Your growth supports expansion plans

## The Bottom Line

Your restaurant is in an excellent position:
- **Growing steadily** with predictable patterns
- **Manageable risks** with low volatility
- **Clear opportunities** for optimization and expansion
- **Competitive advantages** through data-driven planning

You have the data and insights to make confident business decisions. Use this information to optimize your operations, plan for growth, and maximize your profits!`;
            }

            getBusinessFriendlyBusinessPlanningContent() {
                return `# Practical Business Planning

## Your Business Planning Roadmap

This guide gives you practical steps to use your sales data to make better business decisions. No complicated jargon - just clear, actionable advice.

## Understanding Your Growth

### Your Growth Story
- **Weekly Growth:** $178 more sales every week
- **Annual Growth:** About $9,200 more per year
- **Growth Period:** 2+ years of steady growth
- **What This Means:** Your business model is working well

### Growth Planning
- **Safe to Invest:** Your growth is consistent and reliable
- **Plan for Expansion:** You can confidently hire more staff
- **Budget for Growth:** Expect continued increases in revenue
- **Consider New Locations:** Your success supports expansion

##  Seasonal Planning Strategy

### Your Busy Seasons (October-November & April-May)
**What to Do 3 Weeks Before:**
1. **Hire Temporary Staff:** You'll need 25-30% more people
2. **Increase Inventory:** Stock up 20-25% more food and supplies
3. **Plan Marketing Campaigns:** Run ads and promotions
4. **Train Your Team:** Make sure everyone is ready for the rush
5. **Check Equipment:** Ensure everything is working properly

**During Busy Seasons:**
1. **Monitor Sales Daily:** Track your performance
2. **Adjust Staffing:** Add more people if needed
3. **Manage Inventory:** Don't run out of popular items
4. **Keep Quality High:** Don't let service suffer during busy times

### Your Slow Seasons (January-February & July-August)
**Use This Time Wisely:**
1. **Reduce Staffing:** Cut back by about 20%
2. **Do Maintenance:** Fix equipment and update systems
3. **Train Your Team:** Use quiet time for development
4. **Plan for the Future:** Work on new menus and strategies
5. **Review Your Operations:** Look for ways to improve efficiency

## Financial Planning

### Cash Flow Management
- **Peak Seasons:** Expect 25-30% more revenue
- **Slow Seasons:** Plan for 20% less revenue
- **Overall Growth:** Expect continued steady growth

### Budget Planning
- **Staffing Costs:** Plan for seasonal variations
- **Inventory Costs:** Higher during busy seasons
- **Marketing Budget:** Increase before peak periods
- **Maintenance Budget:** Use slow periods for improvements

### Investment Opportunities
- **Staffing:** Safe to invest in additional staff
- **Equipment:** Consider upgrades during slow periods
- **Marketing:** Increase budget before peak seasons
- **Technology:** Systems to help manage seasonal changes

##  Staffing Strategy

### Hiring Plan
- **Peak Seasons:** Start hiring 3 weeks before busy periods
- **Slow Seasons:** Reduce hours or let temporary staff go
- **Training:** Use slow periods for staff development
- **Retention:** Keep good staff by offering consistent hours

### Staffing Levels
- **Busy Times:** 25-30% more staff than normal
- **Slow Times:** 20% less staff than normal
- **Planning:** Use your 12-week forecast to plan hiring

### Staff Management
- **Communication:** Keep staff informed about seasonal changes
- **Training:** Cross-train staff for flexibility
- **Motivation:** Use slow periods for team building
- **Recognition:** Reward staff for handling busy periods well

##  Menu and Inventory Planning

### Seasonal Menu Strategy
- **Peak Seasons:** Offer popular, profitable items
- **Slow Seasons:** Introduce new items and specials
- **Inventory Planning:** Stock up on popular items before busy times
- **Supplier Relationships:** Work with suppliers to handle seasonal changes

### Inventory Management
- **Peak Seasons:** Increase inventory by 20-25%
- **Slow Seasons:** Reduce inventory to save costs
- **Planning:** Use your sales data to predict what you'll need
- **Waste Reduction:** Don't over-order during slow periods

##  Marketing Strategy

### Seasonal Marketing
- **Pre-Peak Campaigns:** Start marketing 2-3 weeks before busy seasons
- **Slow Season Promotions:** Use specials to attract customers during quiet times
- **Social Media:** Use your data to time posts for maximum impact
- **Local Marketing:** Focus on your community during all seasons

### Marketing Budget
- **Peak Seasons:** Increase marketing spend when it's most effective
- **Slow Seasons:** Use cost-effective marketing strategies
- **ROI Tracking:** Measure the effectiveness of your campaigns
- **Customer Feedback:** Use slow periods to gather customer input

## Operational Excellence

### Quality Control
- **Busy Times:** Don't let quality suffer during rushes
- **Slow Times:** Use extra time to improve quality
- **Staff Training:** Regular training to maintain standards
- **Customer Service:** Consistent service across all seasons

### Efficiency Improvements
- **Process Optimization:** Use slow periods to improve operations
- **Technology:** Invest in systems to help manage seasonal changes
- **Equipment:** Maintain and upgrade during quiet times
- **Workflow:** Streamline processes for busy periods

## Action Plan

### Immediate Actions (Next 30 Days)
1. **Review Your Calendar:** Mark your 11 peak weeks for next year
2. **Plan Your Staffing:** Start thinking about hiring for busy seasons
3. **Review Your Menu:** Consider seasonal specials for peak periods
4. **Plan Your Marketing:** Schedule campaigns for pre-peak periods
5. **Check Your Equipment:** Plan maintenance during slow periods

### Short-term Goals (Next 3 Months)
1. **Optimize Your Operations:** Use your slow periods for improvements
2. **Train Your Team:** Use quiet times for training and development
3. **Plan Your Inventory:** Create a seasonal inventory plan
4. **Review Your Pricing:** Consider seasonal pricing strategies
5. **Improve Your Systems:** Invest in technology to help manage changes

### Long-term Strategy (Next Year)
1. **Consider Expansion:** Your growth supports expansion plans
2. **Develop Seasonal Offerings:** Special menus for peak periods
3. **Build Your Team:** Hire and train staff for growth
4. **Invest in Technology:** Systems to help manage seasonal variations
5. **Plan for Growth:** Use your data to guide expansion decisions

## Success Metrics

### Track These Numbers
- **Sales Growth:** Continue your $178 weekly growth
- **Seasonal Performance:** Meet your peak and trough expectations
- **Staff Efficiency:** Maintain quality during busy periods
- **Customer Satisfaction:** Keep customers happy across all seasons
- **Profit Margins:** Optimize for maximum profitability

### Review Regularly
- **Monthly:** Check your performance against predictions
- **Quarterly:** Review and adjust your seasonal plans
- **Annually:** Plan for the next year based on your data

## The Bottom Line

Your restaurant has excellent data that gives you a competitive advantage. Use this information to:
- **Plan ahead** for busy and slow seasons
- **Optimize your operations** for maximum efficiency
- **Make smart investments** in your business
- **Outperform your competition** through data-driven decisions

Remember: Your growth is real, your patterns are predictable, and your future is bright. Use this knowledge to build an even more successful restaurant!`;
            }

            simpleMarkdownToHtml(markdown) {
                let html = markdown;

                // Headers
                html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

                // Bold and italic
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

                // Code blocks
                html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
                html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

                // Links
                html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

                // Lists
                html = html.replace(/^\* (.*$)/gim, '<li>$1</li>');
                html = html.replace(/^- (.*$)/gim, '<li>$1</li>');

                // Wrap lists
                html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');

                // Paragraphs (simple approach)
                html = html.replace(/\n\n/g, '</p><p>');
                html = html.replace(/^(.+)$/gm, '<p>$1</p>');

                // Clean up
                html = html.replace(/<p><\/p>/g, '');
                html = html.replace(/<p><ul>/g, '<ul>');
                html = html.replace(/<\/ul><\/p>/g, '</ul>');

                return html;
            }



            getReportTitle(reportFile) {
                const titles = {
                    'TIME_SERIES_DECOMPOSITION_ANALYSIS.md': 'Core Time Series Analysis',
                    'TREND_DECOMPOSITION_BUSINESS_ANALYSIS.md': 'Advanced Decomposition Analysis',
                    'DETRENDED_SALES_HEATMAP_ANALYSIS.md': 'Detrended Sales Heatmap Analysis',
                    'MONTHLY_SALES_PATTERNS_ANALYSIS.md': 'Monthly Sales Patterns Analysis',
                    'BUSINESS_INTELLIGENCE_SUMMARY_ANALYSIS.md': 'Business Intelligence Summary',
                    'BUSINESS_PLANNING_GUIDE.md': 'Business Planning Guide'
                };
                return titles[reportFile] || 'Report Preview';
            }

            getReportFilename(reportFile) {
                const filenames = {
                    'TIME_SERIES_DECOMPOSITION_ANALYSIS.md': 'Core_Time_Series_Analysis.md',
                    'TREND_DECOMPOSITION_BUSINESS_ANALYSIS.md': 'Advanced_Decomposition_Analysis.md',
                    'DETRENDED_SALES_HEATMAP_ANALYSIS.md': 'Detrended_Sales_Heatmap_Analysis.md',
                    'MONTHLY_SALES_PATTERNS_ANALYSIS.md': 'Monthly_Sales_Patterns_Analysis.md',
                    'BUSINESS_INTELLIGENCE_SUMMARY_ANALYSIS.md': 'Business_Intelligence_Summary.md',
                    'BUSINESS_PLANNING_GUIDE.md': 'Business_Planning_Guide.md'
                };
                return filenames[reportFile] || reportFile;
            }

            closeReportModal() {
                const modal = document.getElementById('reportModal');
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        }

        // Enhanced download function that works with local files
        function openFileInNewTab(reportFile, filename) {
            console.log('Attempting to download:', reportFile);

            // Method 1: Try direct download first
            try {
                const link = document.createElement('a');
                link.href = reportFile;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('Direct download attempted');
                showNotification('Download initiated!', 'success');
                return;
            } catch (error) {
                console.log('Direct download failed, trying fetch method:', error);
            }

            // Method 2: Fetch and create blob
            fetch(reportFile)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(content => {
                    console.log('File content loaded, creating download');

                    // Create blob and download
                    const blob = new Blob([content], { type: 'text/markdown' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);

                    showNotification('File downloaded successfully!', 'success');
                })
                .catch(error => {
                    console.error('Download failed:', error);

                    // Method 3: Fallback - open in new tab
                    try {
                        const link = document.createElement('a');
                        link.href = reportFile;
                        link.target = '_blank';
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        showNotification('File opened in new tab. Use Ctrl+S to save.', 'info');
                    } catch (fallbackError) {
                        console.error('All download methods failed:', fallbackError);
                        showNotification('Download failed. Please right-click the file link and select "Save as..."', 'error');
                    }
                });
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
            `;

            document.body.appendChild(notification);

            // Add styles if not already present
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    .notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 1rem 1.5rem;
                        border-radius: var(--radius-md);
                        color: white;
                        font-weight: 500;
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        animation: slideIn 0.3s ease;
                        max-width: 300px;
                    }
                    .notification-success {
                        background: var(--success-color);
                    }
                    .notification-error {
                        background: var(--error-color);
                    }
                    .notification-warning {
                        background: var(--warning-color);
                    }
                    .notification-info {
                        background: var(--primary-color);
                    }
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Language Toggle Class
        class LanguageToggle {
            constructor() {
                this.isBusinessMode = true; // Start in business mode
                this.toggleBtn = document.getElementById('languageToggle');
                this.toggleText = this.toggleBtn.querySelector('.toggle-text');
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateToggleButton(); // Set initial button state
                this.updateContent();
            }

            setupEventListeners() {
                this.toggleBtn.addEventListener('click', () => {
                    this.isBusinessMode = !this.isBusinessMode;
                    this.updateToggleButton();
                    this.updateContent();
                    this.updatePageTitle();
                });
            }

            updateToggleButton() {
                if (this.isBusinessMode) {
                    this.toggleBtn.classList.add('business-mode');
                    this.toggleText.textContent = 'Scientific View';
                } else {
                    this.toggleBtn.classList.remove('business-mode');
                    this.toggleText.textContent = 'Business View';
                }
            }

            updatePageTitle() {
                const title = document.querySelector('title');
                if (this.isBusinessMode) {
                    title.textContent = 'Upside Time Series Analysis - Business Intelligence Dashboard';
                } else {
                    title.textContent = 'Upside Time Series Analysis - Business Intelligence Dashboard';
                }
            }

            updateContent() {
                this.updateHeaderContent();
                this.updateSectionContent();
                this.updateDownloadCards();
                this.updateTLDRSummaries();
                this.updateAnalysisSections();
                this.updateStatsTiles();
                this.updateDynamicDashboard();
            }

            updateHeaderContent() {
                const headerTitle = document.querySelector('.header h1');
                const headerDesc = document.querySelector('.header p');

                if (headerTitle) {
                    headerTitle.textContent = 'Time Series Analysis';
                }

                // Keep description consistent to prevent layout shifts
                if (headerDesc) {
                    headerDesc.textContent = 'Advanced business intelligence dashboard for restaurant sales forecasting and strategic decision making';
                }
            }

            updateSectionContent() {
                // Update section titles and descriptions
                const sections = {
                    'overview': {
                        scientific: {
                            title: 'Core Time Series Analysis',
                            desc: 'Advanced analysis of your sales data with trend detection and seasonal patterns.'
                        },
                        business: {
                            title: 'Your Restaurant\'s Growth Story',
                            desc: 'Simple breakdown of how your restaurant is performing and growing over time.'
                        }
                    },
                    'analysis': {
                        scientific: {
                            title: 'Advanced Time Series Decomposition',
                            desc: 'Comprehensive statistical decomposition revealing the fundamental components driving your sales patterns.'
                        },
                        business: {
                            title: 'Understanding Your Sales Patterns',
                            desc: 'Clear explanation of what drives your busy and slow seasons, and how to plan for them.'
                        }
                    },
                    'patterns': {
                        scientific: {
                            title: 'Pattern Recognition & Analysis',
                            desc: 'Advanced pattern recognition and seasonal analysis for strategic planning.'
                        },
                        business: {
                            title: 'Your Busy and Slow Seasons',
                            desc: 'Simple guide to understanding when you\'ll be busy and when you\'ll be slow.'
                        }
                    },
                    'intelligence': {
                        scientific: {
                            title: 'Business Intelligence Summary',
                            desc: 'Comprehensive analysis of your restaurant\'s performance with actionable insights for strategic decision making.'
                        },
                        business: {
                            title: 'What This Means for Your Business',
                            desc: 'Clear, practical insights to help you make better business decisions.'
                        }
                    }
                };

                Object.keys(sections).forEach(sectionId => {
                    const section = document.querySelector(`#${sectionId} .section > h2`);
                    const desc = document.querySelector(`#${sectionId} .section > p`);

                    if (section && desc) {
                        const content = this.isBusinessMode ? sections[sectionId].business : sections[sectionId].scientific;
                        section.innerHTML = `${content.title}`;
                        desc.textContent = content.desc;
                    } else {
                        // Fallback - try without the > selector
                        const sectionAlt = document.querySelector(`#${sectionId} .section h2`);
                        const descAlt = document.querySelector(`#${sectionId} .section p`);
                        if (sectionAlt && descAlt) {
                            const content = this.isBusinessMode ? sections[sectionId].business : sections[sectionId].scientific;
                            sectionAlt.innerHTML = `${content.title}`;
                            descAlt.textContent = content.desc;
                        }
                    }
                });
            }

            getSectionIcon(sectionId) {
                const icons = {
                    'overview': 'chart-line',
                    'analysis': 'chart-bar',
                    'patterns': 'pattern',
                    'intelligence': 'brain'
                };
                return icons[sectionId] || 'chart-line';
            }

            updateDownloadCards() {
                const downloadCards = document.querySelectorAll('.download-card h4');

                const businessTitles = {
                    'Core Time Series Analysis': 'Your Growth Story',
                    'Advanced Decomposition Analysis': 'Understanding Your Patterns',
                    'Detrended Sales Heatmap Analysis': 'Your Busy and Slow Seasons',
                    'Monthly Sales Patterns Analysis': 'Monthly Performance Guide',
                    'Business Intelligence Summary': 'What This Means for Your Business',
                    'Business Planning Guide': 'Practical Business Planning'
                };

                const scientificTitles = {
                    'Your Growth Story': 'Core Time Series Analysis',
                    'Understanding Your Patterns': 'Advanced Decomposition Analysis',
                    'Your Busy and Slow Seasons': 'Detrended Sales Heatmap Analysis',
                    'Monthly Performance Guide': 'Monthly Sales Patterns Analysis',
                    'What This Means for Your Business': 'Business Intelligence Summary',
                    'Practical Business Planning': 'Business Planning Guide'
                };

                downloadCards.forEach(card => {
                    const originalText = card.textContent.replace(/^.*?:\s*/, '');
                    if (this.isBusinessMode && businessTitles[originalText]) {
                        card.innerHTML = `${businessTitles[originalText]}`;
                    } else if (!this.isBusinessMode && scientificTitles[originalText]) {
                        card.innerHTML = `${scientificTitles[originalText]}`;
                    }
                });
            }

            getDownloadIcon(title) {
                const icons = {
                    'Core Time Series Analysis': 'chart-line',
                    'Advanced Decomposition Analysis': 'chart-bar',
                    'Detrended Sales Heatmap Analysis': 'fire',
                    'Monthly Sales Patterns Analysis': 'calendar-alt',
                    'Business Intelligence Summary': 'brain',
                    'Business Planning Guide': 'book'
                };
                return icons[title] || 'file-alt';
            }

            updateTLDRSummaries() {
                const tldrContent = {
                    'overview-tldr': {
                        scientific: 'Time series decomposition reveals three distinct components: Original sales series ($40K-$57K) exhibiting linear trend, growth component ($8,500/year) representing 85% variance, and detrended seasonal component ($10K amplitude) with 15% contribution. Trend component dominates variance while seasonal patterns demonstrate statistical significance and predictability.',
                        business: 'Great news! Your restaurant is growing steadily. Sales went from $40,000 to $57,000 per week. You\'re growing by about $8,500 every year. Your busy and slow seasons vary by about $10,000. This means you can plan ahead and know what to expect!'
                    },
                    'analysis-tldr': {
                        scientific: 'Additive decomposition model reveals trend component contributes 85% to total variance ($8,500/year linear growth), seasonal component contributes 15% ($10,000 amplitude with bimodal pattern), and residual component contributes &lt;5% (noise). Model demonstrates excellent fit (R > 0.95) with minimal autocorrelation in residuals.',
                        business: 'Your sales break down into three simple parts: 85% comes from steady growth ($8,500 per year), 15% comes from busy and slow seasons, and less than 5% is just random ups and downs. This means your business is very predictable!'
                    },
                    'patterns-tldr': {
                        scientific: 'Detrended seasonal heatmap analysis reveals bimodal seasonal pattern with primary peaks in October/November (weeks 40-48) and secondary peaks in April/May (weeks 16-22). Trough periods occur in January/February (weeks 1-8) and July/August (weeks 28-35). Pattern consistency enables reliable 8-12 week forecast horizons with $3K confidence intervals.',
                        business: 'This chart shows your busy and slow seasons clearly. Dark blue areas are your busiest times (October/November and April/May). Light blue areas are your quietest times (January/February and July/August). You can see these patterns coming 8-12 weeks ahead, so you can plan ahead!'
                    },
                    'intelligence-tldr': {
                        scientific: 'Statistical analysis confirms significant growth trend ($177.86/week, p &lt; 0.01), strong seasonal component (66.5% seasonal strength index), 11 identified peak weeks annually, and manageable volatility (16.3% coefficient of variation). Reliable 12-week forecast horizon with $3,000 confidence intervals.',
                        business: 'Great news! Your restaurant is growing by $178 every week, you have strong seasonal patterns (66.5%), 11 busy weeks each year, and manageable ups and downs (16.3%). You can predict sales 12 weeks ahead reliably!'
                    }
                };

                Object.keys(tldrContent).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        const content = this.isBusinessMode ? tldrContent[id].business : tldrContent[id].scientific;
                        element.textContent = content;
                    }
                });
            }

            updateAnalysisSections() {
                const analysisContent = {
                    'overview-analysis': {
                        scientific: 'Time series decomposition using additive model reveals three components: (1) Original series showing linear growth trajectory from $40,000 to $57,000 weekly sales over 107-week period, (2) Trend component exhibiting $8,500/year growth rate with statistical significance (p &lt; 0.01), and (3) Detrended seasonal component showing bimodal pattern with $10,000 amplitude. Decomposition confirms trend dominance (85% variance) while seasonal patterns remain statistically significant and predictable.',
                        business: 'This chart shows your restaurant\'s performance in three simple parts. The blue line shows your actual sales growing from $40,000 to $57,000 per week. The green line shows you\'re growing by about $8,500 every year. The red line shows your busy and slow seasons (without the growth trend), so you can see your seasonal patterns clearly.'
                    }
                };

                Object.keys(analysisContent).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        const content = this.isBusinessMode ? analysisContent[id].business : analysisContent[id].scientific;
                        element.innerHTML = `<strong>Analysis Summary:</strong> ${content}`;
                    }
                });

                this.updateInsightCards();
            }

            updateInsightCards() {
                const insightContent = {
                    'patterns-peak-analysis': {
                        scientific: {
                            title: 'Peak Season Analysis',
                            items: [
                                '<strong>October-November:</strong> Darkest blue intensity indicates peak seasonal demand',
                                '<strong>April-May:</strong> Medium-dark blue intensity indicates secondary peak period',
                                '<strong>Peak Reliability:</strong> Consistent timing with minimal variance',
                                '<strong>Strategic Planning:</strong> 8-12 week advance preparation required for optimal resource allocation'
                            ]
                        },
                        business: {
                            title: 'Your Busiest Times',
                            items: [
                                '<strong>October & November:</strong> Your biggest rush of the year',
                                '<strong>April & May:</strong> Your second busiest time',
                                '<strong>Reliability:</strong> These patterns are very consistent',
                                '<strong>Planning:</strong> Start preparing 8-12 weeks ahead'
                            ]
                        }
                    },
                    'patterns-trough-analysis': {
                        scientific: {
                            title: 'Trough Season Analysis',
                            items: [
                                '<strong>January-February:</strong> Lightest blue intensity indicates lowest seasonal demand',
                                '<strong>July-August:</strong> Light-medium blue intensity indicates secondary trough period',
                                '<strong>Trough Consistency:</strong> Regular timing with predictable patterns',
                                '<strong>Cost Management:</strong> Optimal period for strategic cost reduction and resource optimization'
                            ]
                        },
                        business: {
                            title: 'Your Quietest Times',
                            items: [
                                '<strong>January & February:</strong> Your quietest months',
                                '<strong>July & August:</strong> Your second quietest time',
                                '<strong>Consistency:</strong> These patterns are very predictable',
                                '<strong>Opportunity:</strong> Use these times to save money and plan'
                            ]
                        }
                    },
                    'intelligence-strategic': {
                        scientific: {
                            title: 'Strategic Business Insights',
                            items: [
                                '<strong>Investment Confidence:</strong> Growth is statistically significant',
                                '<strong>Seasonal Marketing:</strong> 66.5% seasonal strength',
                                '<strong>Resource Planning:</strong> 11 peak weeks require 25-30% more staffing',
                                '<strong>Cash Flow Management:</strong> $48,673 average weekly sales'
                            ]
                        },
                        business: {
                            title: 'What This Means for Your Business',
                            items: [
                                '<strong>Safe to Invest:</strong> Your growth is real and reliable',
                                '<strong>Marketing Works:</strong> Seasonal campaigns are very effective',
                                '<strong>Staffing Needs:</strong> Plan for 25-30% more staff during busy times',
                                '<strong>Cash Flow:</strong> You average $48,673 per week in sales'
                            ]
                        }
                    },
                    'intelligence-actions': {
                        scientific: {
                            title: 'Immediate Action Items',
                            items: [
                                '<strong>Peak Week Preparation:</strong> Start planning 3 weeks before peaks',
                                '<strong>Seasonal Menu Planning:</strong> Develop seasonal specials',
                                '<strong>Marketing Calendar:</strong> Schedule campaigns for pre-peak periods',
                                '<strong>Inventory Management:</strong> Stock up 20-25% during peak seasons'
                            ]
                        },
                        business: {
                            title: 'What You Should Do Now',
                            items: [
                                '<strong>Plan for Busy Times:</strong> Start preparing 3 weeks before peaks',
                                '<strong>Create Seasonal Menus:</strong> Develop specials for busy seasons',
                                '<strong>Schedule Marketing:</strong> Run campaigns before busy periods',
                                '<strong>Stock Up:</strong> Increase inventory by 20-25% before busy times'
                            ]
                        }
                    },
                    'analysis-business-insights': {
                        scientific: {
                            title: 'Key Business Insights',
                            items: [
                                '<strong>Growth Trajectory:</strong> $17,000 increase over 2-year period',
                                '<strong>Seasonal Strength:</strong> $10,000 seasonal amplitude',
                                '<strong>Peak Preparation:</strong> 3-week advance notice required',
                                '<strong>Resource Planning:</strong> 25-30% staffing increase needed'
                            ]
                        },
                        business: {
                            title: 'What This Means for You',
                            items: [
                                '<strong>Strong Growth:</strong> You\'ve grown by $17,000 over 2 years',
                                '<strong>Seasonal Patterns:</strong> Sales vary by $10,000 with seasons',
                                '<strong>Planning Time:</strong> You need 3 weeks to prepare for busy times',
                                '<strong>Staffing Needs:</strong> Plan for 25-30% more staff during peaks'
                            ]
                        }
                    },
                    'analysis-statistical': {
                        scientific: {
                            title: 'Statistical Components',
                            items: [
                                '<strong>Trend Component:</strong> 85% contribution',
                                '<strong>Seasonal Component:</strong> 15% contribution',
                                '<strong>Residual Component:</strong> &lt;5% contribution',
                                '<strong>Model Quality:</strong> Excellent fit (R > 0.95)'
                            ]
                        },
                        business: {
                            title: 'How Your Sales Break Down',
                            items: [
                                '<strong>Steady Growth:</strong> 85% of your sales come from growth',
                                '<strong>Seasonal Patterns:</strong> 15% comes from busy/slow seasons',
                                '<strong>Random Variation:</strong> Less than 5% is unpredictable',
                                '<strong>Reliability:</strong> These patterns are very predictable'
                            ]
                        }
                    }
                };

                Object.keys(insightContent).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        const content = this.isBusinessMode ? insightContent[id].business : insightContent[id].scientific;
                        const titleElement = element.querySelector('h4');
                        const listElement = element.querySelector('ul');

                        if (titleElement) {
                            titleElement.innerHTML = `${content.title}`;
                        }

                        if (listElement) {
                            listElement.innerHTML = content.items.map(item => `<li>${item}</li>`).join('');
                        }
                    }
                });
            }

            getInsightIcon(title) {
                const icons = {
                    'Peak Season Analysis': 'arrow-up',
                    'Your Busiest Times': 'arrow-up',
                    'Trough Season Analysis': 'arrow-down',
                    'Your Quietest Times': 'arrow-down',
                    'Strategic Business Insights': 'rocket',
                    'What This Means for Your Business': 'rocket',
                    'Immediate Action Items': 'tasks',
                    'What You Should Do Now': 'tasks',
                    'Key Business Insights': 'chart-line',
                    'What This Means for You': 'chart-line',
                    'Statistical Components': 'calculator',
                    'How Your Sales Break Down': 'calculator'
                };
                return icons[title] || 'info-circle';
            }

            updateStatsTiles() {
                const statsContent = {
                    'stat-1': {
                        scientific: {
                            value: '$177.86',
                            label: 'Weekly Growth Rate'
                        },
                        business: {
                            value: '$178',
                            label: 'Weekly Growth'
                        }
                    },
                    'stat-2': {
                        scientific: {
                            value: '66.5%',
                            label: 'Seasonal Strength Index'
                        },
                        business: {
                            value: '66.5%',
                            label: 'Seasonal Strength'
                        }
                    },
                    'stat-3': {
                        scientific: {
                            value: '11',
                            label: 'Peak Weeks/Year'
                        },
                        business: {
                            value: '11',
                            label: 'Busy Weeks/Year'
                        }
                    },
                    'stat-4': {
                        scientific: {
                            value: '16.3%',
                            label: 'Volatility (CV)'
                        },
                        business: {
                            value: '16.3%',
                            label: 'Ups & Downs'
                        }
                    },
                    'stat-5': {
                        scientific: {
                            value: '12',
                            label: 'Forecast Horizon'
                        },
                        business: {
                            value: '12',
                            label: 'Week Forecast'
                        }
                    }
                };

                Object.keys(statsContent).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        const content = this.isBusinessMode ? statsContent[id].business : statsContent[id].scientific;
                        const valueElement = element.querySelector('.stat-value');
                        const labelElement = element.querySelector('.stat-label');

                        if (valueElement) {
                            valueElement.textContent = content.value;
                        }

                        if (labelElement) {
                            labelElement.textContent = content.label;
                        }
                    }
                });
            }

            updateDynamicDashboard() {
                // Update the dynamic dashboard if it exists
                if (window.dynamicDashboard) {
                    window.dynamicDashboard.renderMetrics();
                }
            }
        }

        // Dynamic Metrics Dashboard Class
        class DynamicMetricsDashboard {
            constructor() {
                this.container = document.querySelector('.metrics-grid');
                this.init();
                this.dashboardData = null; // Store fetched data
            }

            async init() {
                this.metricsGrid = document.querySelector('.metrics-grid'); // Ensure this is set
                // Fetch data first
                await this.fetchDashboardData();
                this.renderMetrics();
                this.setupEventListeners();
                this.setupScrollAnimation();
            }

            async fetchDashboardData() {
                try {
                    // 1. Try Inlined Data first (bypasses CORS on local files)
                    if (window.dashboardData) {
                        this.dashboardData = window.dashboardData;
                    }
                    // 2. Fallback to fetch (requires server or permissive browser)
                    else {
                        const response = await fetch('dashboard_data.json');
                        if (response.ok) {
                            this.dashboardData = await response.json();
                        }
                    }

                    if (this.dashboardData) {
                        // Update header timestamp if available
                        if (this.dashboardData.metadata && this.dashboardData.metadata.generated_at) {
                            const dateEl = document.getElementById('last-updated');
                            if (dateEl) {
                                dateEl.textContent = `Last Updated: ${this.dashboardData.metadata.generated_at}`;
                                dateEl.style.display = 'block'; // Ensure visibility
                            }
                        }

                        // Update Stationarity Badge
                        if (this.dashboardData.metrics) {
                            const stationarityEl = document.getElementById('stationarity-badge');
                            if (stationarityEl) {
                                stationarityEl.textContent = this.dashboardData.metrics.is_stationary ? 'STATIONARY' : 'NON-STATIONARY';
                                stationarityEl.className = `badge ${this.dashboardData.metrics.is_stationary ? 'success' : 'warning'}`;
                            }
                        }
                    } else {
                        console.warn("Using static data (dashboard_data.json not found)");
                        const dateEl = document.getElementById('last-updated');
                        if (dateEl) dateEl.textContent = "Last Updated: Using Default Data";
                    }
                } catch (e) {
                    console.error("Error fetching dashboard data:", e);
                    const dateEl = document.getElementById('last-updated');
                    if (dateEl) dateEl.textContent = "Last Updated: Error Loading Data";
                }
            }

            setupEventListeners() {
                // Resize listener for responsive adjustments
                window.addEventListener('resize', () => this.renderMetrics());

                // Export Button
                const exportBtn = document.getElementById('export-metrics-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => this.exportMetrics());
                }

                // Refresh Button
                const refreshBtn = document.getElementById('refresh-metrics-btn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => this.refreshMetrics());
                }

                // Listen for custom language/mode change event if it exists
                window.addEventListener('languageChanged', () => {
                    this.renderMetrics();
                });
            }

            setupScrollAnimation() {
                // Placeholder for scroll animation logic
            }

            renderMetrics() {
                if (!this.metricsGrid) return;

                const isBusinessMode = window.languageToggle ? window.languageToggle.isBusinessMode : true;
                const metrics = this.getMetrics(isBusinessMode);

                this.metricsGrid.innerHTML = metrics.map(metric => this.createMetricCard(metric)).join('');
            }

            getMetrics(isBusinessMode) {
                // Helper to format values
                const fmtMoney = (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(v);
                const fmtPct = (v) => new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 1 }).format(v);

                // Default values (static fallback)
                let d = {
                    avg_sales: 48673,
                    growth_rate: 177.86,
                    seasonal_strength: 0.665,
                    volatility: 0.163,
                    total_weeks: 12
                };

                // Use fetched data if available
                if (this.dashboardData && this.dashboardData.metrics) {
                    d = this.dashboardData.metrics;
                }

                if (isBusinessMode) {
                    return [
                        {
                            icon: 'chart-line',
                            value: d.growth_rate > 100 ? fmtMoney(d.growth_rate) : fmtPct(d.growth_rate / 100),
                            label: 'Weekly Growth',
                            description: 'Your restaurant is growing steadily every week',
                            trend: 'positive',
                            trendText: ' Growing'
                        },
                        {
                            icon: 'calendar-alt',
                            value: fmtPct(d.seasonal_strength),
                            label: 'Seasonal Strength',
                            description: 'Strong seasonal patterns you can rely on',
                            trend: 'positive',
                            trendText: ' Strong'
                        },
                        {
                            icon: 'fire',
                            value: '11', // Not in JSON yet, keep static
                            label: 'Busy Weeks/Year',
                            description: 'Peak periods when you need extra staff',
                            trend: 'neutral',
                            trendText: ' Consistent'
                        },
                        {
                            icon: 'chart-bar',
                            value: fmtPct(d.volatility),
                            label: 'Ups & Downs',
                            description: 'Manageable variation in your sales',
                            trend: 'positive',
                            trendText: ' Stable'
                        },
                        {
                            icon: 'eye',
                            value: d.total_weeks,
                            label: 'Weeks Analyzed',
                            description: 'Total historical weeks processed',
                            trend: 'positive',
                            trendText: ' Reliable'
                        },
                        {
                            icon: 'dollar-sign',
                            value: fmtMoney(d.avg_sales),
                            label: 'Average Sales',
                            description: 'Your typical weekly revenue',
                            trend: 'positive',
                            trendText: ' Strong'
                        }
                    ];
                } else {
                    return [
                        {
                            icon: 'chart-line',
                            value: fmtMoney(d.growth_rate),
                            label: 'Weekly Growth Rate',
                            description: 'Statistical growth rate with confidence intervals',
                            trend: 'positive',
                            trendText: ' Significant'
                        },
                        {
                            icon: 'calendar-alt',
                            value: fmtPct(d.seasonal_strength),
                            label: 'Seasonal Strength Index',
                            description: 'Quantified seasonal pattern strength',
                            trend: 'positive',
                            trendText: ' High'
                        },
                        {
                            icon: 'fire',
                            value: '11',
                            label: 'Peak Weeks/Year',
                            description: 'Identified peak periods through analysis',
                            trend: 'neutral',
                            trendText: ' Consistent'
                        },
                        {
                            icon: 'chart-bar',
                            value: fmtPct(d.volatility),
                            label: 'Volatility (CV)',
                            description: 'Coefficient of variation in sales data',
                            trend: 'positive',
                            trendText: ' Low'
                        },
                        {
                            icon: 'eye',
                            value: d.total_weeks,
                            label: 'Data Points',
                            description: 'Total weeks included in analysis',
                            trend: 'positive',
                            trendText: ' Extended'
                        },
                        {
                            icon: 'dollar-sign',
                            value: fmtMoney(d.avg_sales),
                            label: 'Mean Weekly Sales',
                            description: 'Statistical mean of weekly revenue',
                            trend: 'positive',
                            trendText: ' Robust'
                        }
                    ];
                }
            }

            createMetricCard(metric) {
                return `
                        <div class="metric-card">
                            <div class="metric-icon">
                            </div>
                            <div class="metric-value">${metric.value}</div>
                            <div class="metric-label">${metric.label}</div>
                            <div class="metric-description">${metric.description}</div>
                            <div class="metric-trend ${metric.trend}">
                                ${metric.trendText}
                            </div>
                        </div>
                    `;
            }

            getTrendIcon(trend) {
                const icons = {
                    'positive': 'arrow-up',
                    'negative': 'arrow-down',
                    'neutral': 'minus'
                };
                return icons[trend] || 'minus';
            }

            refreshMetrics() {
                this.fetchDashboardData().then(() => {
                    this.renderMetrics();
                    // showNotification is global, assuming it exists
                    if (typeof showNotification === 'function') {
                        showNotification('Metrics refreshed!', 'success');
                    }
                });
            }

            exportMetrics() {
                const isBusinessMode = window.languageToggle ? window.languageToggle.isBusinessMode : true;
                const metrics = this.getMetrics(isBusinessMode);

                const csvContent = this.convertToCSV(metrics);
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `restaurant_metrics_${isBusinessMode ? 'business' : 'scientific'}.csv`;
                link.click();
                window.URL.revokeObjectURL(url);

                if (typeof showNotification === 'function') {
                    showNotification('Metrics exported successfully!', 'success');
                }
            }

            convertToCSV(metrics) {
                const headers = ['Metric', 'Value', 'Label', 'Description', 'Trend'];
                const rows = metrics.map(metric => [
                    metric.label,
                    metric.value,
                    metric.label,
                    metric.description,
                    metric.trendText
                ]);

                return [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            }
        }

        // Service Worker for offline functionality (future enhancement)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // navigator.serviceWorker.register('/sw.js');
            });
        }
    </script>
    <script>
        // Inline data to bypass CORS restricted when opening index.html locally
        window.dashboardData = {
            "metadata": {
                "generated_at": "2025-12-17 22:55:34",
                "version": "1.0.0"
            },
            "metrics": {
                "total_weeks": 212,
                "avg_sales": 49041.6013,
                "growth_rate": 90.5899,
                "seasonal_strength": 0.3053,
                "volatility": 0.1888,
                "is_stationary": true
            }
            // Truncated time_series for brevity in inline script, full data in JSON file
        };

        document.addEventListener('DOMContentLoaded', () => {
            new DynamicMetricsDashboard();
        });
    </script>
</body>

</html>